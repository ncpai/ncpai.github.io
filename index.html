<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V·∫†N S·ª∞ NH∆Ø √ù - H·ªá Th·ªëng T·ªïng H·ª£p 4 H·ªá Th·ªëng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #F9FAFB;
        }
        .btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn:active {
            transform: translateY(1px);
        }
        .card-glow-total { box-shadow: 0 0 25px rgba(168, 85, 247, 0.7); }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background-color: #1f2937;
            padding: 1.5rem; border-radius: 1rem;
            width: 90%; max-width: 500px;
            animation: slideIn 0.3s ease-out;
            border: 1px solid #374151;
        }
        .toast-notification {
            position: fixed; top: 20px; right: 20px;
            background-color: #1f2937; color: white;
            padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            z-index: 100; animation: slideDown 0.5s ease;
            border-left: 4px solid;
        }
        .warning-alert {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: #f59e0b; color: white;
            padding: 1rem 2rem; border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            z-index: 100; animation: slideDown 0.5s ease;
            border-left: 4px solid #d97706;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-100%); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .system-frame {
            border: 2px solid #374151;
            border-radius: 0.75rem;
            background: #1f2937;
            transition: all 0.3s ease;
        }
        .system-frame.active {
            border-color: #8b5cf6;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
        }
        .history-chart {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 1px;
            height: 40px;
            padding: 5px 0;
            overflow: hidden;
        }
        .history-bar {
            flex-shrink: 0;
            width: 3px;
            border-radius: 1px;
        }
        .history-bar-correct {
            background-color: #3b82f6;
            height: 100%;
        }
        .history-bar-incorrect {
            background-color: #ef4444;
            height: 40%;
        }
        .accuracy-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .accuracy-high { background-color: #10b981; color: white; }
        .accuracy-medium { background-color: #f59e0b; color: white; }
        .accuracy-low { background-color: #ef4444; color: white; }
        .system-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        @media (min-width: 1024px) {
            .system-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .game-bar-chart {
            height: 300px;
            margin-top: 1rem;
        }
        .confidence-interval-chart {
            height: 200px;
            margin-top: 1rem;
        }
        .game-result-chip {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin: 1px;
        }
        .game-correct { background-color: #10b981; color: white; }
        .game-incorrect { background-color: #ef4444; color: white; }
        .game-neutral { background-color: #6b7280; color: white; }
        .final-decision-bar {
            flex-shrink: 0;
            width: 8px;
            border-radius: 2px;
            margin: 0 1px;
        }
        .final-decision-correct {
            background-color: #3b82f6;
            height: 100%;
        }
        .final-decision-incorrect {
            background-color: #ef4444;
            height: 40%;
        }
        .pattern-analysis {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        .pattern-analysis h5 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 0.5rem;
        }
        .pattern-analysis pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: #93c5fd;
            overflow-x: auto;
            margin-bottom: 0.5rem;
        }
        .pattern-analysis .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            font-size: 0.75rem;
        }
        .pattern-analysis .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.375rem;
        }
        .pattern-analysis .stat-label {
            color: #9ca3af;
        }
        .pattern-analysis .stat-value {
            font-weight: 600;
            color: #60a5fa;
        }
        .pattern-analysis .recommendation {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(96, 165, 250, 0.1);
            border-left: 3px solid #3b82f6;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            color: #93c5fd;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="modal-container"></div>
    <div id="toast-container"></div>
    <div id="warning-container"></div>

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-900 via-violet-900 to-purple-900 p-8 rounded-2xl shadow-2xl text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-pink-400 to-purple-400 mb-3">
                V·∫†N S·ª∞ NH∆Ø √ù
            </h1>
            <p class="text-gray-300 text-lg">H·ªá Th·ªëng T·ªïng H·ª£p Ph√¢n T√≠ch C·∫ßu Cao C·∫•p - 4 H·ªá Th·ªëng</p>
            <div class="flex flex-wrap justify-center gap-4 mt-4">
                <span class="px-3 py-1 bg-blue-600 rounded-full text-sm font-semibold">HT1: Pattern Matching</span>
                <span class="px-3 py-1 bg-green-600 rounded-full text-sm font-semibold">HT2: Fixed & Optimized</span>
                <span class="px-3 py-1 bg-orange-600 rounded-full text-sm font-semibold">HT3: Standard System</span>
                <span class="px-3 py-1 bg-pink-600 rounded-full text-sm font-semibold">HT4: Advanced System</span>
                <span class="px-3 py-1 bg-purple-600 rounded-full text-sm font-semibold">T·ªïng H·ª£p Th√¥ng Minh</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left Column: Control Panel -->
            <div class="lg:col-span-1 space-y-6">
                <!-- System Control -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-blue-300">‚öôÔ∏è ƒêi·ªÅu Khi·ªÉn H·ªá Th·ªëng</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="showAllFrames()" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg">üëÅÔ∏è Hi·ªÉn Th·ªã T·∫•t C·∫£</button>
                            <button onclick="hideAllFrames()" class="btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg">üëª ·∫®n T·∫•t C·∫£</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="syncAllSystems()" class="btn bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">üîÑ ƒê·ªìng B·ªô H√≥a</button>
                            <button onclick="resetAllSystems()" class="btn bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg">üîÑ Reset T·∫•t C·∫£</button>
                        </div>
                    </div>
                </div>

                <!-- Session Management -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-blue-300">üìÅ Qu·∫£n L√Ω Phi√™n Chung</h2>
                    
                    <div class="mb-4">
                        <select id="masterSessionSelector" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="">Ch·ªçn phi√™n ƒë·ªÉ ƒë·ªìng b·ªô...</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="createNewSessionAll()" class="btn bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">‚ûï T·∫°o M·ªõi</button>
                        <button onclick="renameMasterSession()" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg">‚úèÔ∏è ƒê·ªïi T√™n</button>
                        <button onclick="exportMasterData()" class="btn bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 rounded-lg col-span-2">üì§ Xu·∫•t T·ªïng Th·ªÉ</button>
                        <button onclick="document.getElementById('masterFileInput').click()" class="btn bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg col-span-2">üì• Nh·∫≠p D·ªØ Li·ªáu</button>
                        <input type="file" id="masterFileInput" class="hidden" accept=".json" onchange="importMasterData(event)">
                    </div>
                </div>

                <!-- Input Section -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-blue-300">üé≤ Nh·∫≠p K·∫øt Qu·∫£ V√°n Hi·ªán T·∫°i</h2>
                    <p class="text-gray-400 text-sm mb-4">K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c ƒë·ªìng b·ªô ƒë·∫øn t·∫•t c·∫£ h·ªá th·ªëng</p>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <button onclick="addResultToAll('P')" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-6 rounded-lg text-2xl">
                            <span>üë§</span> PLAYER
                        </button>
                        <button onclick="addResultToAll('B')" class="btn bg-red-600 hover:bg-red-500 text-white font-bold py-6 rounded-lg text-2xl">
                            <span>üè¶</span> BANKER
                        </button>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="undoLastAll()" class="btn flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg">‚Ü©Ô∏è Ho√†n T√°c</button>
                        <button onclick="clearHistoryAll()" class="btn flex-1 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-lg">üóëÔ∏è X√≥a L·ªãch S·ª≠</button>
                    </div>
                </div>

                <!-- Current Session Stats -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-green-300">üìä Th·ªëng K√™ Phi√™n Hi·ªán T·∫°i</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center bg-gray-700 p-4 rounded-lg">
                            <span class="font-medium text-gray-300">T·ªïng s·ªë v√°n</span>
                            <span id="totalGamesMaster" class="text-2xl font-bold text-white">0</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-4 rounded-lg">
                            <span class="font-medium text-gray-300">Phi√™n ƒëang ch·ªçn</span>
                            <span id="currentSessionName" class="text-lg font-semibold text-cyan-400">Ch∆∞a ch·ªçn</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Systems Display (4 systems) -->
            <div class="lg:col-span-3">
                <div class="system-grid">
                    <!-- HT1 Frame -->
                    <div class="system-frame" id="ht1-frame">
                        <div class="flex justify-between items-center bg-gray-900 p-4 rounded-t-lg">
                            <h2 class="text-xl font-semibold text-blue-300">üî∑ HT1 - Pattern Matching</h2>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-400">ƒê·ªô ch√≠nh x√°c:</span>
                                <span id="ht1-accuracy" class="accuracy-badge accuracy-low">0.0%</span>
                                <button onclick="toggleFrame('ht1')" class="text-gray-400 hover:text-white">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path id="ht1-toggle-icon" fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="ht1-content" class="h-[400px]">
                            <iframe src="ht1.html" id="ht1-iframe" class="w-full h-full rounded-b-lg" frameborder="0"></iframe>
                        </div>
                    </div>

                    <!-- HT2 Frame -->
                    <div class="system-frame" id="ht2-frame">
                        <div class="flex justify-between items-center bg-gray-900 p-4 rounded-t-lg">
                            <h2 class="text-xl font-semibold text-green-300">üî∂ HT2 - Fixed & Optimized</h2>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-400">ƒê·ªô ch√≠nh x√°c:</span>
                                <span id="ht2-accuracy" class="accuracy-badge accuracy-low">0.0%</span>
                                <button onclick="toggleFrame('ht2')" class="text-gray-400 hover:text-white">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path id="ht2-toggle-icon" fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="ht2-content" class="h-[400px]">
                            <iframe src="ht2.html" id="ht2-iframe" class="w-full h-full rounded-b-lg" frameborder="0"></iframe>
                        </div>
                    </div>

                    <!-- HT3 Frame -->
                    <div class="system-frame" id="ht3-frame">
                        <div class="flex justify-between items-center bg-gray-900 p-4 rounded-t-lg">
                            <h2 class="text-xl font-semibold text-orange-300">üî∏ HT3 - Standard System</h2>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-400">ƒê·ªô ch√≠nh x√°c:</span>
                                <span id="ht3-accuracy" class="accuracy-badge accuracy-low">0.0%</span>
                                <button onclick="toggleFrame('ht3')" class="text-gray-400 hover:text-white">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path id="ht3-toggle-icon" fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="ht3-content" class="h-[400px]">
                            <iframe src="ht3.html" id="ht3-iframe" class="w-full h-full rounded-b-lg" frameborder="0"></iframe>
                        </div>
                    </div>

                    <!-- HT4 Frame -->
                    <div class="system-frame" id="ht4-frame">
                        <div class="flex justify-between items-center bg-gray-900 p-4 rounded-t-lg">
                            <h2 class="text-xl font-semibold text-pink-300">üîπ HT4 - Advanced System</h2>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-400">ƒê·ªô ch√≠nh x√°c:</span>
                                <span id="ht4-accuracy" class="accuracy-badge accuracy-low">0.0%</span>
                                <button onclick="toggleFrame('ht4')" class="text-gray-400 hover:text-white">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path id="ht4-toggle-icon" fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="ht4-content" class="h-[400px]">
                            <iframe src="ht4.html" id="ht4-iframe" class="w-full h-full rounded-b-lg" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ƒê·ªô Ch√≠nh X√°c H·ªá Th·ªëng ƒê·ªÅ Xu·∫•t Hi·ªán T·∫°i -->
        <div class="mt-8 bg-gradient-to-r from-purple-900 to-blue-900 p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-6 text-center text-yellow-300">üìä ƒê·ªò CH√çNH X√ÅC H·ªÜ TH·ªêNG ƒê·ªÄ XU·∫§T HI·ªÜN T·∫†I (4 H·ªÜ TH·ªêNG)</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- HT1 System Details -->
                <div class="bg-gray-800 bg-opacity-70 p-4 rounded-xl">
                    <h3 class="text-lg font-semibold mb-3 text-center text-blue-300">üî∑ HT1 - Pattern Matching</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">üß† Ph√°n Quy·∫øt:</span>
                            <span id="ht1-verdict-prediction" class="font-bold text-xl text-blue-400">-</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">üîê Ch·ªët Ph√°n Quy·∫øt:</span>
                            <span id="ht1-chot-prediction" class="font-bold text-xl text-purple-400">-</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">Kho·∫£ng t·ª∑ l·ªá:</span>
                            <span id="ht1-confidence-range" class="font-bold text-cyan-400">-</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">T·ªâ l·ªá kho·∫£ng:</span>
                            <span id="ht1-range-accuracy" class="font-bold text-green-400">-</span>
                        </div>
                        
                        <!-- Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá -->
                        <div class="bg-gray-900 p-3 rounded-lg mt-4">
                            <h4 class="text-center text-sm text-gray-400 mb-2">Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá</h4>
                            <div id="ht1-interval-chart" class="history-chart" style="height: 60px;"></div>
                            <div id="ht1-range-games" class="mt-2 text-xs text-gray-400 text-center"></div>
                        </div>
                        
                        <!-- BI·ªÇU ƒê·ªí K·∫æT H·ª¢P -->
                        <div class="bg-gray-900 p-3 rounded-lg mt-4">
                            <h4 class="text-center text-sm text-gray-400 mb-2">Bi·ªÉu ƒë·ªì k·∫øt h·ª£p</h4>
                            <div id="ht1-combined-chart" class="history-chart" style="height: 60px;">
                                <p class="text-gray-600 text-xs text-center w-full">ƒêang t·∫£i...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HT2 System Details -->
                <div class="bg-gray-800 bg-opacity-70 p-4 rounded-xl">
                    <h3 class="text-lg font-semibold mb-3 text-center text-green-300">üî∂ HT2 - Fixed & Optimized</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">üß† Ph√°n Quy·∫øt:</span>
                            <span id="ht2-verdict-prediction" class="font-bold text-xl text-blue-400">-</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">üîê Ch·ªët Ph√°n Quy·∫øt:</span>
                            <span id="ht2-chot-prediction" class="font-bold text-xl text-purple-400">-</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">Kho·∫£ng t·ª∑ l·ªá:</span>
                            <span id="ht2-confidence-range" class="font-bold text-cyan-400">-</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">T·ªâ l·ªá kho·∫£ng:</span>
                            <span id="ht2-range-accuracy" class="font-bold text-green-400">-</span>
                        </div>
                        
                        <!-- Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá -->
                        <div class="bg-gray-900 p-3 rounded-lg mt-4">
                            <h4 class="text-center text-sm text-gray-400 mb-2">Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá</h4>
                            <div id="ht2-interval-chart" class="history-chart" style="height: 60px;"></div>
                            <div id="ht2-range-games" class="mt-2 text-xs text-gray-400 text-center"></div>
                        </div>
                        
                        <!-- BI·ªÇU ƒê·ªí K·∫æT H·ª¢P -->
                        <div class="bg-gray-900 p-3 rounded-lg mt-4">
                            <h4 class="text-center text-sm text-gray-400 mb-2">Bi·ªÉu ƒë·ªì k·∫øt h·ª£p</h4>
                            <div id="ht2-combined-chart" class="history-chart" style="height: 60px;">
                                <p class="text-gray-600 text-xs text-center w-full">ƒêang t·∫£i...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HT3 System Details -->
                <div class="bg-gray-800 bg-opacity-70 p-4 rounded-xl">
                    <h3 class="text-lg font-semibold mb-3 text-center text-orange-300">üî∏ HT3 - Standard System</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">üß† Ph√°n Quy·∫øt:</span>
                            <span id="ht3-verdict-prediction" class="font-bold text-xl text-blue-400">-</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">üîê Ch·ªët Ph√°n Quy·∫øt:</span>
                            <span id="ht3-chot-prediction" class="font-bold text-xl text-purple-400">-</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">Kho·∫£ng t·ª∑ l·ªá:</span>
                            <span id="ht3-confidence-range" class="font-bold text-cyan-400">-</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">T·ªâ l·ªá kho·∫£ng:</span>
                            <span id="ht3-range-accuracy" class="font-bold text-green-400">-</span>
                        </div>
                        
                        <!-- Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá -->
                        <div class="bg-gray-900 p-3 rounded-lg mt-4">
                            <h4 class="text-center text-sm text-gray-400 mb-2">Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá</h4>
                            <div id="ht3-interval-chart" class="history-chart" style="height: 60px;"></div>
                            <div id="ht3-range-games" class="mt-2 text-xs text-gray-400 text-center"></div>
                        </div>
                        
                        <!-- BI·ªÇU ƒê·ªí K·∫æT H·ª¢P -->
                        <div class="bg-gray-900 p-3 rounded-lg mt-4">
                            <h4 class="text-center text-sm text-gray-400 mb-2">Bi·ªÉu ƒë·ªì k·∫øt h·ª£p</h4>
                            <div id="ht3-combined-chart" class="history-chart" style="height: 60px;">
                                <p class="text-gray-600 text-xs text-center w-full">ƒêang t·∫£i...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HT4 System Details -->
                <div class="bg-gray-800 bg-opacity-70 p-4 rounded-xl">
                    <h3 class="text-lg font-semibold mb-3 text-center text-pink-300">üîπ HT4 - Advanced System</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">üß† Ph√°n Quy·∫øt:</span>
                            <span id="ht4-verdict-prediction" class="font-bold text-xl text-blue-400">-</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">üîê Ch·ªët Ph√°n Quy·∫øt:</span>
                            <span id="ht4-chot-prediction" class="font-bold text-xl text-purple-400">-</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">Kho·∫£ng t·ª∑ l·ªá:</span>
                            <span id="ht4-confidence-range" class="font-bold text-cyan-400">-</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <span class="text-gray-300">T·ªâ l·ªá kho·∫£ng:</span>
                            <span id="ht4-range-accuracy" class="font-bold text-green-400">-</span>
                        </div>
                        
                        <!-- Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá -->
                        <div class="bg-gray-900 p-3 rounded-lg mt-4">
                            <h4 class="text-center text-sm text-gray-400 mb-2">Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá</h4>
                            <div id="ht4-interval-chart" class="history-chart" style="height: 60px;"></div>
                            <div id="ht4-range-games" class="mt-2 text-xs text-gray-400 text-center"></div>
                        </div>
                        
                        <!-- BI·ªÇU ƒê·ªí K·∫æT H·ª¢P -->
                        <div class="bg-gray-900 p-3 rounded-lg mt-4">
                            <h4 class="text-center text-sm text-gray-400 mb-2">Bi·ªÉu ƒë·ªì k·∫øt h·ª£p</h4>
                            <div id="ht4-combined-chart" class="history-chart" style="height: 60px;">
                                <p class="text-gray-600 text-xs text-center w-full">ƒêang t·∫£i...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Decision Panel -->
        <div class="mt-8">
            <div class="bg-gradient-to-r from-purple-900 to-pink-900 p-6 rounded-2xl shadow-lg card-glow-total">
                <h2 class="text-2xl font-semibold mb-6 text-center text-yellow-300">üèÜ PH√ÅN QUY·∫æT T·ªîNG H·ª¢P - V·∫†N S·ª∞ NH∆Ø √ù (4 H·ªÜ TH·ªêNG)</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- System Accuracies -->
                    <div class="bg-gray-900 bg-opacity-50 p-4 rounded-xl">
                        <h3 class="text-lg font-semibold mb-3 text-center text-blue-300">ƒê·ªô Ch√≠nh X√°c H·ªá Th·ªëng</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">HT1 Pattern Matching:</span>
                                <span id="accuracy-ht1-display" class="font-bold">0.0%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">HT2 Fixed & Optimized:</span>
                                <span id="accuracy-ht2-display" class="font-bold">0.0%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">HT3 Standard System:</span>
                                <span id="accuracy-ht3-display" class="font-bold">0.0%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">HT4 Advanced System:</span>
                                <span id="accuracy-ht4-display" class="font-bold">0.0%</span>
                            </div>
                            <div class="flex justify-between items-center border-t border-gray-700 pt-3">
                                <span class="text-lg font-semibold text-yellow-300">H·ªá th·ªëng ∆∞u ti√™n:</span>
                                <span id="priority-system" class="text-lg font-bold text-green-400">ƒêang t√≠nh...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Final Decision -->
                    <div class="bg-gray-900 bg-opacity-50 p-4 rounded-xl md:col-span-2">
                        <h3 class="text-lg font-semibold mb-3 text-center text-green-300">QUY·∫æT ƒê·ªäNH CU·ªêI C√ôNG</h3>
                        <div class="text-center">
                            <div id="finalDecisionContainer" class="py-6 rounded-lg border-2 border-purple-500 mb-4">
                                <p class="text-sm text-gray-400 mb-2">ƒê·ªÅ xu·∫•t t·ª´ h·ªá th·ªëng t·ªïng h·ª£p (4 h·ªá th·ªëng):</p>
                                <p id="finalDecisionText" class="text-3xl md:text-4xl font-extrabold text-gray-300">ƒêANG T√çNH TO√ÅN...</p>
                                <div id="decisionReason" class="mt-4 text-sm text-gray-400 px-4">
                                    H·ªá th·ªëng ƒëang ph√¢n t√≠ch quy lu·∫≠t t·ª´ 4 h·ªá th·ªëng con...
                                </div>
                            </div>
                            <div class="flex flex-wrap justify-center gap-4">
                                <button onclick="forcePlayerDecision()" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg text-lg">
                                    üë§ CH·ªêT PLAYER
                                </button>
                                <button onclick="forceBankerDecision()" class="btn bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-lg text-lg">
                                    üè¶ CH·ªêT BANKER
                                </button>
                                <button onclick="showPatternAnalysis()" class="btn bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg text-lg">
                                    üìä PH√ÇN T√çCH QUY LU·∫¨T
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PH√ÇN T√çCH QUY LU·∫¨T T·ªîNG H·ª¢P -->
                <div class="mt-6 bg-gray-900 bg-opacity-50 p-4 rounded-xl">
                    <h3 class="text-lg font-semibold mb-4 text-center text-cyan-300">üîç PH√ÇN T√çCH QUY LU·∫¨T T·ªîNG H·ª¢P</h3>
                    
                    <!-- Pattern Analysis Results -->
                    <div id="pattern-analysis-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- HT1 Pattern Analysis -->
                        <div class="pattern-analysis">
                            <h5 class="text-blue-300">üî∑ HT1 Pattern Analysis</h5>
                            <pre id="ht1-pattern-string" class="text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu...</pre>
                            <div class="stats">
                                <div class="stat-item">
                                    <span class="stat-label">D‚ÜíS:</span>
                                    <span id="ht1-d-to-s" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">S‚ÜíD:</span>
                                    <span id="ht1-s-to-d" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">DD‚ÜíS:</span>
                                    <span id="ht1-dd-to-s" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">SS‚ÜíD:</span>
                                    <span id="ht1-ss-to-d" class="stat-value">0%</span>
                                </div>
                            </div>
                            <div id="ht1-recommendation" class="recommendation">ƒêang ph√¢n t√≠ch...</div>
                        </div>
                        
                        <!-- HT2 Pattern Analysis -->
                        <div class="pattern-analysis">
                            <h5 class="text-green-300">üî∂ HT2 Pattern Analysis</h5>
                            <pre id="ht2-pattern-string" class="text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu...</pre>
                            <div class="stats">
                                <div class="stat-item">
                                    <span class="stat-label">D‚ÜíS:</span>
                                    <span id="ht2-d-to-s" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">S‚ÜíD:</span>
                                    <span id="ht2-s-to-d" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">DD‚ÜíS:</span>
                                    <span id="ht2-dd-to-s" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">SS‚ÜíD:</span>
                                    <span id="ht2-ss-to-d" class="stat-value">0%</span>
                                </div>
                            </div>
                            <div id="ht2-recommendation" class="recommendation">ƒêang ph√¢n t√≠ch...</div>
                        </div>
                        
                        <!-- HT3 Pattern Analysis -->
                        <div class="pattern-analysis">
                            <h5 class="text-orange-300">üî∏ HT3 Pattern Analysis</h5>
                            <pre id="ht3-pattern-string" class="text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu...</pre>
                            <div class="stats">
                                <div class="stat-item">
                                    <span class="stat-label">D‚ÜíS:</span>
                                    <span id="ht3-d-to-s" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">S‚ÜíD:</span>
                                    <span id="ht3-s-to-d" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">DD‚ÜíS:</span>
                                    <span id="ht3-dd-to-s" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">SS‚ÜíD:</span>
                                    <span id="ht3-ss-to-d" class="stat-value">0%</span>
                                </div>
                            </div>
                            <div id="ht3-recommendation" class="recommendation">ƒêang ph√¢n t√≠ch...</div>
                        </div>
                        
                        <!-- HT4 Pattern Analysis -->
                        <div class="pattern-analysis">
                            <h5 class="text-pink-300">üîπ HT4 Pattern Analysis</h5>
                            <pre id="ht4-pattern-string" class="text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu...</pre>
                            <div class="stats">
                                <div class="stat-item">
                                    <span class="stat-label">D‚ÜíS:</span>
                                    <span id="ht4-d-to-s" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">S‚ÜíD:</span>
                                    <span id="ht4-s-to-d" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">DD‚ÜíS:</span>
                                    <span id="ht4-dd-to-s" class="stat-value">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">SS‚ÜíD:</span>
                                    <span id="ht4-ss-to-d" class="stat-value">0%</span>
                                </div>
                            </div>
                            <div id="ht4-recommendation" class="recommendation">ƒêang ph√¢n t√≠ch...</div>
                        </div>
                    </div>
                </div>

                <!-- PH·∫¶N TH·ªêNG K√ä V√Ä BI·ªÇU ƒê·ªí CHO QUY·∫æT ƒê·ªäNH CU·ªêI C√ôNG -->
                <div class="mt-6 bg-gray-900 bg-opacity-50 p-4 rounded-xl">
                    <h3 class="text-lg font-semibold mb-4 text-center text-cyan-300">üìä TH·ªêNG K√ä ƒê√öNG/SAI QUY·∫æT ƒê·ªäNH CU·ªêI C√ôNG</h3>
                    
                    <!-- Stats Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gray-800 p-4 rounded-lg text-center">
                            <div class="text-gray-300 text-sm mb-1">T·ªïng s·ªë v√°n</div>
                            <div id="final-total-games" class="text-3xl font-bold text-white">0</div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg text-center">
                            <div class="text-gray-300 text-sm mb-1">S·ªë v√°n ƒë√∫ng</div>
                            <div id="final-correct-games" class="text-3xl font-bold text-green-400">0</div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg text-center">
                            <div class="text-gray-300 text-sm mb-1">T·ª∑ l·ªá ƒë√∫ng</div>
                            <div id="final-accuracy-rate" class="text-3xl font-bold text-yellow-400">0%</div>
                        </div>
                    </div>
                    
                    <!-- Final Decision History Chart -->
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold mb-3 text-center text-gray-300">BI·ªÇU ƒê·ªí ƒê√öNG/SAI T·ª™NG V√ÅN - QUY·∫æT ƒê·ªäNH CU·ªêI C√ôNG</h4>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <div class="mb-3">
                                <div class="flex items-center justify-center gap-4 mb-2">
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 bg-blue-500 mr-2"></div>
                                        <span class="text-sm text-gray-300">ƒê√öNG (c·ªôt d√†i)</span>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 bg-red-500 mr-2"></div>
                                        <span class="text-sm text-gray-300">SAI (c·ªôt ng·∫Øn)</span>
                                    </div>
                                </div>
                            </div>
                            <div id="final-decision-chart" class="history-chart" style="height: 80px;">
                                <p class="text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu...</p>
                            </div>
                            <div class="flex justify-between mt-2 text-xs text-gray-400">
                                <span>V√°n 1</span>
                                <span>V√°n cu·ªëi</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Final Decisions Table -->
                    <div class="mt-4 bg-gray-800 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold mb-3 text-center text-gray-300">L·ªäCH S·ª¨ QUY·∫æT ƒê·ªäNH CU·ªêI C√ôNG</h4>
                        <div id="final-decision-history" class="max-h-48 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="p-2 text-left">V√°n</th>
                                        <th class="p-2 text-left">Quy·∫øt ƒë·ªãnh</th>
                                        <th class="p-2 text-left">K·∫øt qu·∫£</th>
                                        <th class="p-2 text-left">Tr·∫°ng th√°i</th>
                                        <th class="p-2 text-left">L√Ω do</th>
                                    </tr>
                                </thead>
                                <tbody id="final-decision-history-body" class="text-gray-300">
                                    <tr>
                                        <td colspan="5" class="p-4 text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-gray-800 rounded-lg">
                        <div class="text-sm text-gray-400">Tr·∫°ng th√°i HT1</div>
                        <div id="ht1-status" class="text-green-400 font-semibold">üü¢ ƒêang ho·∫°t ƒë·ªông</div>
                    </div>
                    <div class="text-center p-3 bg-gray-800 rounded-lg">
                        <div class="text-sm text-gray-400">Tr·∫°ng th√°i HT2</div>
                        <div id="ht2-status" class="text-green-400 font-semibold">üü¢ ƒêang ho·∫°t ƒë·ªông</div>
                    </div>
                    <div class="text-center p-3 bg-gray-800 rounded-lg">
                        <div class="text-sm text-gray-400">Tr·∫°ng th√°i HT3</div>
                        <div id="ht3-status" class="text-green-400 font-semibold">üü¢ ƒêang ho·∫°t ƒë·ªông</div>
                    </div>
                    <div class="text-center p-3 bg-gray-800 rounded-lg">
                        <div class="text-sm text-gray-400">Tr·∫°ng th√°i HT4</div>
                        <div id="ht4-status" class="text-green-400 font-semibold">üü¢ ƒêang ho·∫°t ƒë·ªông</div>
                    </div>
                    <div class="text-center p-3 bg-gray-800 rounded-lg md:col-span-4">
                        <div class="text-sm text-gray-400">Tr·∫°ng th√°i ƒë·ªìng b·ªô</div>
                        <div id="sync-status" class="text-yellow-400 font-semibold">ƒêang ƒë·ªìng b·ªô...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>H·ªá th·ªëng "V·∫†N S·ª∞ NH∆Ø √ù" - T·ªïng h·ª£p t·ª´ 4 h·ªá th·ªëng (HT1, HT2, HT3, HT4) | Phi√™n b·∫£n 3.0 (Ph√¢n t√≠ch quy lu·∫≠t)</p>
            <p class="mt-2">L∆∞u √Ω: C√°c h·ªá th·ªëng ch·∫°y ƒë·ªôc l·∫≠p nh∆∞ng ƒë·ªìng b·ªô v·ªÅ d·ªØ li·ªáu v√† phi√™n l√†m vi·ªác</p>
        </div>
    </div>

    <script>
        // =================== GLOBAL STATE ===================
        const masterState = {
            currentSessionId: null,
            currentSessionName: 'Ch∆∞a ch·ªçn',
            sessions: {},
            ht1Accuracy: 0,
            ht2Accuracy: 0,
            ht3Accuracy: 0,
            ht4Accuracy: 0,
            ht1ChotHistory: [],
            ht2ChotHistory: [],
            ht3ChotHistory: [],
            ht4ChotHistory: [],
            lastDecision: null,
            lastDecisionReason: '',
            systemsReady: {
                ht1: false,
                ht2: false,
                ht3: false,
                ht4: false
            },
            predictions: {
                ht1: null,
                ht2: null,
                ht3: null,
                ht4: null
            },
            systemDetails: {
                ht1: { verdict: null, chot: null, range: null, rangeAccuracy: null, intervalHistory: [] },
                ht2: { verdict: null, chot: null, range: null, rangeAccuracy: null, intervalHistory: [] },
                ht3: { verdict: null, chot: null, range: null, rangeAccuracy: null, intervalHistory: [] },
                ht4: { verdict: null, chot: null, range: null, rangeAccuracy: null, intervalHistory: [] }
            },
            // L·ªäCH S·ª¨ QUY·∫æT ƒê·ªäNH CU·ªêI C√ôNG
            finalDecisionHistory: [],
            // L∆∞u tr·ªØ c√°c c·∫£nh b√°o ƒë√£ hi·ªÉn th·ªã
            displayedWarnings: {},
            // L∆∞u tr·ªØ ph√¢n t√≠ch quy lu·∫≠t
            patternAnalysis: {
                ht1: { interval: null, combined: null },
                ht2: { interval: null, combined: null },
                ht3: { interval: null, combined: null },
                ht4: { interval: null, combined: null }
            }
        };

        // Chart instances
        let gameAccuracyChart = null;
        let currentChartSystem = 'ht1';

        // =================== H√ÄM PH√ÇN T√çCH QUY LU·∫¨T ===================
        function analyzeChartPattern(chartHistory, chartType = 'interval') {
            if (!chartHistory || chartHistory.length < 5) {
                return {
                    hasPattern: false,
                    has100Percent: false,
                    confidence: 0,
                    patternType: null,
                    patternString: '',
                    transitions: {},
                    rates: {
                        DtoS: '0',
                        StoD: '0',
                        DDtoS: '0',
                        SStoD: '0'
                    },
                    rawRates: {
                        DtoS: 0,
                        StoD: 0,
                        DDtoS: 0,
                        SStoD: 0
                    },
                    recommendations: [],
                    length: 0
                };
            }
            
            // Chuy·ªÉn l·ªãch s·ª≠ th√†nh chu·ªói D (ƒê√∫ng) v√† S (Sai)
            let patternString = '';
            for (let i = 0; i < chartHistory.length; i++) {
                const item = chartHistory[i];
                let isCorrect = false;
                
                if (item.correct !== undefined) {
                    isCorrect = item.correct === true;
                } else if (item.predicted !== undefined && item.actual !== undefined) {
                    isCorrect = item.predicted === item.actual;
                } else if (item.isCorrect !== undefined) {
                    isCorrect = item.isCorrect === true;
                }
                
                patternString += isCorrect ? 'D' : 'S';
            }
            
            // Ph√¢n t√≠ch c√°c chuy·ªÉn ƒë·ªïi
            let transitions = {
                DtoS: 0, DtoD: 0,
                StoD: 0, StoS: 0,
                DDtoS: 0, DDtoD: 0,
                SStoD: 0, SStoS: 0
            };
            
            // ƒê·∫øm c√°c chuy·ªÉn ƒë·ªïi ƒë∆°n
            for (let i = 0; i < patternString.length - 1; i++) {
                const current = patternString[i];
                const next = patternString[i + 1];
                
                if (current === 'D' && next === 'S') transitions.DtoS++;
                if (current === 'D' && next === 'D') transitions.DtoD++;
                if (current === 'S' && next === 'D') transitions.StoD++;
                if (current === 'S' && next === 'S') transitions.StoS++;
            }
            
            // ƒê·∫øm c√°c chuy·ªÉn ƒë·ªïi ƒë√¥i
            for (let i = 0; i < patternString.length - 2; i++) {
                const pair = patternString.substring(i, i + 2);
                const next = patternString[i + 2];
                
                if (pair === 'DD' && next === 'S') transitions.DDtoS++;
                if (pair === 'DD' && next === 'D') transitions.DDtoD++;
                if (pair === 'SS' && next === 'D') transitions.SStoD++;
                if (pair === 'SS' && next === 'S') transitions.SStoS++;
            }
            
            // T√≠nh t·ª∑ l·ªá CH√çNH X√ÅC (kh√¥ng l√†m tr√≤n s·ªõm)
            const DtoSTotal = transitions.DtoS + transitions.DtoD;
            const StoDTotal = transitions.StoD + transitions.StoS;
            const DDtoSTotal = transitions.DDtoS + transitions.DDtoD;
            const SStoDTotal = transitions.SStoD + transitions.SStoS;
            
            // T√≠nh ch√≠nh x√°c ƒë·∫øn 2 ch·ªØ s·ªë th·∫≠p ph√¢n
            const DtoSRate = DtoSTotal > 0 ? (transitions.DtoS / DtoSTotal * 100) : 0;
            const StoDRate = StoDTotal > 0 ? (transitions.StoD / StoDTotal * 100) : 0;
            const DDtoSRate = DDtoSTotal > 0 ? (transitions.DDtoS / DDtoSTotal * 100) : 0;
            const SStoDRate = SStoDTotal > 0 ? (transitions.SStoD / SStoDTotal * 100) : 0;
            
            // CH·ªà COI L√Ä QUY LU·∫¨T 100% KHI ƒê√öNG 100% (kh√¥ng l√†m tr√≤n)
            const has100PercentRule = 
                DtoSRate === 100 || StoDRate === 100 || 
                DDtoSRate === 100 || SStoDRate === 100;
            
            // Ki·ªÉm tra xem c√≥ quy lu·∫≠t kh√¥ng (t·ª∑ l·ªá >= 70% ho·∫∑c <= 30%)
            const hasStrongPattern = has100PercentRule || 
                DtoSRate >= 70 || DtoSRate <= 30 ||
                StoDRate >= 70 || StoDRate <= 30 ||
                DDtoSRate >= 70 || DDtoSRate <= 30 ||
                SStoDRate >= 70 || SStoDRate <= 30;
            
            // ƒê·ªô tin c·∫≠y: cao h∆°n n·∫øu c√≥ quy lu·∫≠t 100%
            let confidence = 0;
            if (patternString.length >= 10) confidence += 30;
            if (patternString.length >= 15) confidence += 20;
            if (hasStrongPattern) confidence += 40;
            if (has100PercentRule) confidence += 10; // Bonus cho quy lu·∫≠t 100%
            
            // X√°c ƒë·ªãnh lo·∫°i quy lu·∫≠t
            let patternType = null;
            let recommendations = [];
            
            // ∆Øu ti√™n quy lu·∫≠t 100%
            if (DtoSRate === 100) {
                patternType = 'DtoS_100';
                recommendations.push(`üö® D‚ÜíS 100% (${transitions.DtoS}/${DtoSTotal}) - Sau ƒê√öNG th√¨ LU√îN SAI -> NG∆Ø·ª¢C`);
            } else if (StoDRate === 100) {
                patternType = 'StoD_100';
                recommendations.push(`üö® S‚ÜíD 100% (${transitions.StoD}/${StoDTotal}) - Sau SAI th√¨ LU√îN ƒê√öNG -> THEO`);
            } else if (DDtoSRate === 100) {
                patternType = 'DDtoS_100';
                recommendations.push(`üö® DD‚ÜíS 100% (${transitions.DDtoS}/${DDtoSTotal}) - Sau 2 ƒê√öNG th√¨ LU√îN SAI -> NG∆Ø·ª¢C`);
            } else if (SStoDRate === 100) {
                patternType = 'SStoD_100';
                recommendations.push(`üö® SS‚ÜíD 100% (${transitions.SStoD}/${SStoDTotal}) - Sau 2 SAI th√¨ LU√îN ƒê√öNG -> THEO`);
            } else if (DtoSRate >= 70) {
                patternType = 'DtoS_HIGH';
                recommendations.push(`D‚ÜíS ${DtoSRate.toFixed(1)}% - Sau ƒë√∫ng th∆∞·ªùng sai -> Xem x√©t NG∆Ø·ª¢C`);
            } else if (StoDRate >= 70) {
                patternType = 'StoD_HIGH';
                recommendations.push(`S‚ÜíD ${StoDRate.toFixed(1)}% - Sau sai th∆∞·ªùng ƒë√∫ng -> Xem x√©t THEO`);
            } else if (DDtoSRate >= 70) {
                patternType = 'DDtoS_HIGH';
                recommendations.push(`DD‚ÜíS ${DDtoSRate.toFixed(1)}% - Sau 2 ƒë√∫ng th∆∞·ªùng sai -> Xem x√©t NG∆Ø·ª¢C`);
            } else if (SStoDRate >= 70) {
                patternType = 'SStoD_HIGH';
                recommendations.push(`SS‚ÜíD ${SStoDRate.toFixed(1)}% - Sau 2 sai th∆∞·ªùng ƒë√∫ng -> Xem x√©t THEO`);
            }
            
            // Format t·ª∑ l·ªá ƒë·ªÉ hi·ªÉn th·ªã
            const formatRate = (rate) => rate.toFixed(1);
            
            return {
                hasPattern: hasStrongPattern,
                has100Percent: has100PercentRule,
                confidence: Math.min(confidence, 100),
                patternType: patternType,
                patternString: patternString,
                transitions: transitions,
                rates: {
                    DtoS: formatRate(DtoSRate),
                    StoD: formatRate(StoDRate),
                    DDtoS: formatRate(DDtoSRate),
                    SStoD: formatRate(SStoDRate)
                },
                rawRates: {
                    DtoS: DtoSRate,
                    StoD: StoDRate,
                    DDtoS: DDtoSRate,
                    SStoD: SStoDRate
                },
                recommendations: recommendations,
                length: patternString.length
            };
        }

        // =================== THU·∫¨T TO√ÅN QUY·∫æT ƒê·ªäNH CU·ªêI C√ôNG CH·ªà D·ª∞A TR√äN QUY LU·∫¨T 100% ===================
        function calculateFinalDecision() {
            console.log("T√≠nh to√°n quy·∫øt ƒë·ªãnh cu·ªëi c√πng v·ªõi thu·∫≠t to√°n CH·ªà D·ª∞A TR√äN QUY LU·∫¨T 100%...");
            
            const systems = ['ht1', 'ht2', 'ht3', 'ht4'];
            
            // L∆∞u tr·ªØ t·∫•t c·∫£ quy lu·∫≠t 100%
            let all100PercentRules = [];
            
            // Ph√¢n t√≠ch t·ª´ng h·ªá th·ªëng
            for (const system of systems) {
                const details = masterState.systemDetails[system];
                if (!details) continue;
                
                // L·∫•y d·ªØ li·ªáu t·ª´ hai bi·ªÉu ƒë·ªì
                const intervalHistory = details.intervalHistory || [];
                const combinedHistory = masterState[`${system}ChotHistory`] || [];
                
                // Ph√¢n t√≠ch Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá
                const intervalAnalysis = analyzeChartPattern(intervalHistory, 'interval');
                
                // Ph√¢n t√≠ch Bi·ªÉu ƒë·ªì k·∫øt h·ª£p
                const combinedAnalysis = analyzeChartPattern(combinedHistory, 'combined');
                
                // L∆∞u ph√¢n t√≠ch ƒë·ªÉ hi·ªÉn th·ªã
                masterState.patternAnalysis[system] = {
                    interval: intervalAnalysis,
                    combined: combinedAnalysis
                };
                
                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ph√¢n t√≠ch
                updatePatternAnalysisDisplay(system, intervalAnalysis, combinedAnalysis);
                
                // CH·ªà KI·ªÇM TRA QUY LU·∫¨T 100%
                // Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá
                checkAndAdd100PercentRules(all100PercentRules, system, 'interval', intervalAnalysis, details);
                
                // Bi·ªÉu ƒë·ªì k·∫øt h·ª£p
                checkAndAdd100PercentRules(all100PercentRules, system, 'combined', combinedAnalysis, details);
            }
            
            // N·∫øu c√≥ quy lu·∫≠t 100%
            if (all100PercentRules.length > 0) {
                // Ch·ªçn quy lu·∫≠t t·ªët nh·∫•t: ƒë·ªô d√†i chu·ªói d√†i nh·∫•t (c√†ng nhi·ªÅu v√°n c√†ng ƒë√°ng tin)
                all100PercentRules.sort((a, b) => {
                    // ∆Øu ti√™n ƒë·ªô d√†i chu·ªói
                    if (b.length !== a.length) {
                        return b.length - a.length;
                    }
                    // N·∫øu b·∫±ng nhau, ∆∞u ti√™n confidence cao h∆°n
                    return b.confidence - a.confidence;
                });
                
                const bestRule = all100PercentRules[0];
                
                // X√°c ƒë·ªãnh quy·∫øt ƒë·ªãnh d·ª±a tr√™n lo·∫°i quy lu·∫≠t 100%
                let decision = null;
                let reason = `üö® ${bestRule.system.toUpperCase()} - ${bestRule.chartName} c√≥ QUY LU·∫¨T 100%: ${bestRule.ruleType} (${bestRule.length} v√°n). `;
                
                // L·∫•y k·∫øt qu·∫£ g·ªëc c·ªßa h·ªá th·ªëng ƒë√≥
                let originalDecision = bestRule.originalDecision;
                if (!originalDecision) {
                    // N·∫øu kh√¥ng c√≥ d·ª± ƒëo√°n g·ªëc, l·∫•y d·ª± ƒëo√°n hi·ªán t·∫°i c·ªßa h·ªá th·ªëng ƒë√≥
                    if (bestRule.chartType === 'interval') {
                        originalDecision = getOriginalVerdict(masterState.systemDetails[bestRule.system].verdict);
                    } else {
                        originalDecision = getOriginalVerdict(masterState.systemDetails[bestRule.system].chot);
                    }
                }
                
                if (!originalDecision) {
                    originalDecision = 'P'; // M·∫∑c ƒë·ªãnh
                }
                
                // √Åp d·ª•ng quy lu·∫≠t 100%
                switch (bestRule.ruleType) {
                    case 'DtoS':
                        // D‚ÜíS 100%: sau khi ƒê√öNG th√¨ LU√îN SAI -> NG∆Ø·ª¢C v·ªõi k·∫øt qu·∫£ g·ªëc
                        decision = originalDecision === 'P' ? 'B' : 'P';
                        reason += `ƒê√öNG lu√¥n chuy·ªÉn th√†nh SAI -> NG∆Ø·ª¢C v·ªõi d·ª± ƒëo√°n g·ªëc (${originalDecision})`;
                        break;
                    case 'StoD':
                        // S‚ÜíD 100%: sau khi SAI th√¨ LU√îN ƒê√öNG -> THEO k·∫øt qu·∫£ g·ªëc
                        decision = originalDecision;
                        reason += `SAI lu√¥n chuy·ªÉn th√†nh ƒê√öNG -> THEO d·ª± ƒëo√°n g·ªëc (${originalDecision})`;
                        break;
                    case 'DDtoS':
                        // DD‚ÜíS 100%: sau 2 l·∫ßn ƒê√öNG th√¨ LU√îN SAI -> NG∆Ø·ª¢C v·ªõi k·∫øt qu·∫£ g·ªëc
                        decision = originalDecision === 'P' ? 'B' : 'P';
                        reason += `2 ƒê√öNG li√™n ti·∫øp lu√¥n chuy·ªÉn th√†nh SAI -> NG∆Ø·ª¢C v·ªõi d·ª± ƒëo√°n g·ªëc (${originalDecision})`;
                        break;
                    case 'SStoD':
                        // SS‚ÜíD 100%: sau 2 l·∫ßn SAI th√¨ LU√îN ƒê√öNG -> THEO k·∫øt qu·∫£ g·ªëc
                        decision = originalDecision;
                        reason += `2 SAI li√™n ti·∫øp lu√¥n chuy·ªÉn th√†nh ƒê√öNG -> THEO d·ª± ƒëo√°n g·ªëc (${originalDecision})`;
                        break;
                    default:
                        decision = null;
                        reason = "Quy lu·∫≠t 100% kh√¥ng x√°c ƒë·ªãnh";
                }
                
                if (decision) {
                    console.log(`Quy·∫øt ƒë·ªãnh cu·ªëi c√πng (100%): ${decision}, L√Ω do: ${reason}`);
                    updateFinalDecisionDisplay(decision, reason, bestRule.system.toUpperCase());
                    
                    // Hi·ªÉn th·ªã c·∫£nh b√°o ƒë·∫∑c bi·ªát cho quy lu·∫≠t 100%
                    show100PercentWarning(bestRule);
                    return;
                }
            }
            
            // N·∫øu KH√îNG c√≥ quy lu·∫≠t 100% n√†o
            console.log("KH√îNG C√ì QUY LU·∫¨T 100% - ƒê·ªÄ XU·∫§T D·ª™NG L·∫†I HO·∫∂C ƒê·ªîI B√ÄN");
            updateFinalDecisionDisplay(null, "‚ö†Ô∏è KH√îNG C√ì QUY LU·∫¨T 100% N√ÄO. KH√îNG ƒê·ª¶ C∆† S·ªû ƒê·ªÇ ƒê∆ØA RA QUY·∫æT ƒê·ªäNH. ƒê·ªÄ XU·∫§T D·ª™NG L·∫†I HO·∫∂C ƒê·ªîI B√ÄN!", "D·ª™NG L·∫†I");
            showWarning("‚ö†Ô∏è C·∫¢NH B√ÅO: Kh√¥ng t√¨m th·∫•y quy lu·∫≠t 100% n√†o trong c·∫£ 4 h·ªá th·ªëng. ƒê·ªÅ xu·∫•t D·ª™NG L·∫†I ho·∫∑c ƒê·ªîI B√ÄN!");
        }

        // =================== H√ÄM H·ªñ TR·ª¢ QUY·∫æT ƒê·ªäNH 100% ===================
        function getOriginalVerdict(verdictString) {
            if (!verdictString || verdictString === '-') return null;
            
            verdictString = verdictString.trim().toUpperCase();
            
            if (verdictString === 'P' || verdictString === 'B') {
                return verdictString;
            }
            
            if (verdictString.includes('NG∆Ø·ª¢C')) {
                if (verdictString.includes('P')) return 'B';
                if (verdictString.includes('B')) return 'P';
            }
            
            if (verdictString.includes('THEO')) {
                if (verdictString.includes('P')) return 'P';
                if (verdictString.includes('B')) return 'B';
            }
            
            return null;
        }

        function checkAndAdd100PercentRules(allRules, system, chartType, analysis, systemDetails) {
            // Ch·ªâ x√©t n·∫øu c√≥ quy lu·∫≠t
            if (!analysis.hasPattern) return;
            
            const chartName = chartType === 'interval' ? 'Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá' : 'Bi·ªÉu ƒë·ªì k·∫øt h·ª£p';
            
            // L·∫•y k·∫øt qu·∫£ g·ªëc c·ªßa h·ªá th·ªëng
            let originalDecision = null;
            if (chartType === 'interval') {
                originalDecision = getOriginalVerdict(systemDetails.verdict);
            } else {
                originalDecision = getOriginalVerdict(systemDetails.chot);
            }
            
            // CH·ªà KI·ªÇM TRA C√ÅC T·ª∂ L·ªÜ 100% (kh√¥ng ch·∫•p nh·∫≠n 99.9% hay 100.0% l√†m tr√≤n)
            const rulesToCheck = [
                { type: 'DtoS', value: analysis.rawRates.DtoS, label: 'D‚ÜíS' },
                { type: 'StoD', value: analysis.rawRates.StoD, label: 'S‚ÜíD' },
                { type: 'DDtoS', value: analysis.rawRates.DDtoS, label: 'DD‚ÜíS' },
                { type: 'SStoD', value: analysis.rawRates.SStoD, label: 'SS‚ÜíD' }
            ];
            
            rulesToCheck.forEach(rule => {
                // CH·ªà CH·∫§P NH·∫¨N CH√çNH X√ÅC 100%
                if (parseFloat(rule.value) === 100) {
                    // Ki·ªÉm tra s·ªë l∆∞·ª£ng m·∫´u ƒë·ªß l·ªõn (√≠t nh·∫•t 3 l·∫ßn xu·∫•t hi·ªán)
                    const minOccurrences = 3;
                    let occurrences = 0;
                    
                    // ƒê·∫øm s·ªë l·∫ßn xu·∫•t hi·ªán c·ªßa m·∫´u n√†y trong chu·ªói
                    if (rule.type === 'DtoS') {
                        occurrences = analysis.transitions.DtoS;
                    } else if (rule.type === 'StoD') {
                        occurrences = analysis.transitions.StoD;
                    } else if (rule.type === 'DDtoS') {
                        occurrences = analysis.transitions.DDtoS;
                    } else if (rule.type === 'SStoD') {
                        occurrences = analysis.transitions.SStoD;
                    }
                    
                    if (occurrences >= minOccurrences) {
                        allRules.push({
                            system: system,
                            chartType: chartType,
                            chartName: chartName,
                            ruleType: rule.type,
                            ruleLabel: rule.label,
                            ruleValue: rule.value,
                            occurrences: occurrences,
                            confidence: analysis.confidence,
                            length: analysis.length,
                            originalDecision: originalDecision,
                            patternString: analysis.patternString
                        });
                        
                        console.log(`T√¨m th·∫•y quy lu·∫≠t 100%: ${system} - ${chartType} - ${rule.type} (${occurrences} l·∫ßn, ${analysis.length} v√°n)`);
                    }
                }
            });
        }

        function show100PercentWarning(rule) {
            const warningContainer = document.getElementById('warning-container');
            
            let warningHTML = `
                <div class="warning-alert" style="background-color: #10b981; border-left-color: #059669;">
                    <span>üéØ T√åM TH·∫§Y QUY LU·∫¨T 100%!</span>
                    <div style="font-size: 0.9rem; margin-top: 5px;">
                        ${rule.system.toUpperCase()} - ${rule.chartName}: ${rule.ruleLabel} = 100% 
                        (${rule.occurrences} l·∫ßn trong ${rule.length} v√°n)
                    </div>
                </div>
            `;
            
            warningContainer.innerHTML = warningHTML;
            
            // T·ª± ƒë·ªông ·∫©n sau 10 gi√¢y
            setTimeout(() => {
                warningContainer.innerHTML = '';
            }, 10000);
        }

        function showWarning(message) {
            const warningContainer = document.getElementById('warning-container');
            
            const warning = document.createElement('div');
            warning.className = 'warning-alert';
            warning.innerHTML = message;
            
            warningContainer.innerHTML = '';
            warningContainer.appendChild(warning);
            
            setTimeout(() => {
                warning.style.animation = 'fadeOut 0.5s ease';
                setTimeout(() => {
                    if (warningContainer.contains(warning)) {
                        warningContainer.removeChild(warning);
                    }
                }, 500);
            }, 8000);
        }

        // =================== C·∫¨P NH·∫¨T HI·ªÇN TH·ªä PH√ÇN T√çCH QUY LU·∫¨T ===================
        function updatePatternAnalysisDisplay(system, intervalAnalysis, combinedAnalysis) {
            // Ch·ªçn bi·ªÉu ƒë·ªì c√≥ quy lu·∫≠t m·∫°nh h∆°n ƒë·ªÉ hi·ªÉn th·ªã
            let displayAnalysis = intervalAnalysis;
            let chartType = 'interval';
            
            // ∆Øu ti√™n quy lu·∫≠t 100%
            const intervalHas100 = intervalAnalysis.has100Percent;
            const combinedHas100 = combinedAnalysis.has100Percent;
            
            if (combinedHas100 && !intervalHas100) {
                displayAnalysis = combinedAnalysis;
                chartType = 'combined';
            } else if (intervalHas100 && !combinedHas100) {
                displayAnalysis = intervalAnalysis;
                chartType = 'interval';
            } else if (combinedAnalysis.confidence > intervalAnalysis.confidence) {
                displayAnalysis = combinedAnalysis;
                chartType = 'combined';
            }
            
            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
            const patternStringEl = document.getElementById(`${system}-pattern-string`);
            const dToSEl = document.getElementById(`${system}-d-to-s`);
            const sToDEl = document.getElementById(`${system}-s-to-d`);
            const ddToSEl = document.getElementById(`${system}-dd-to-s`);
            const ssToDEl = document.getElementById(`${system}-ss-to-d`);
            const recommendationEl = document.getElementById(`${system}-recommendation`);
            
            if (patternStringEl) {
                patternStringEl.textContent = displayAnalysis.patternString || 'Ch∆∞a c√≥ d·ªØ li·ªáu';
                
                // Highlight quy lu·∫≠t 100%
                if (displayAnalysis.has100Percent) {
                    patternStringEl.style.color = '#10b981';
                    patternStringEl.style.fontWeight = 'bold';
                }
            }
            
            // C·∫≠p nh·∫≠t c√°c t·ª∑ l·ªá v·ªõi highlight cho 100%
            updateRateDisplay(dToSEl, displayAnalysis.rates.DtoS, 'D‚ÜíS');
            updateRateDisplay(sToDEl, displayAnalysis.rates.StoD, 'S‚ÜíD');
            updateRateDisplay(ddToSEl, displayAnalysis.rates.DDtoS, 'DD‚ÜíS');
            updateRateDisplay(ssToDEl, displayAnalysis.rates.SStoD, 'SS‚ÜíD');
            
            if (recommendationEl) {
                if (displayAnalysis.recommendations.length > 0) {
                    // ∆Øu ti√™n hi·ªÉn th·ªã khuy·∫øn ngh·ªã t·ª´ quy lu·∫≠t 100%
                    const has100 = displayAnalysis.has100Percent;
                    if (has100) {
                        recommendationEl.innerHTML = `<span style="color: #10b981; font-weight: bold;">üö® QUY LU·∫¨T 100%: </span>${displayAnalysis.recommendations[0]}`;
                    } else {
                        recommendationEl.textContent = displayAnalysis.recommendations[0];
                    }
                } else {
                    recommendationEl.textContent = displayAnalysis.hasPattern ? 'C√≥ quy lu·∫≠t nh∆∞ng ch∆∞a r√µ r√†ng' : 'Kh√¥ng c√≥ quy lu·∫≠t r√µ r√†ng';
                }
            }
        }

        function updateRateDisplay(element, value, label) {
            if (!element) return;
            
            const numValue = parseFloat(value);
            element.textContent = `${value}%`;
            
            // ƒê·∫∑t m√†u s·∫Øc d·ª±a tr√™n gi√° tr·ªã
            if (numValue === 100) {
                element.style.color = '#10b981'; // Xanh l√° ƒë·∫≠m cho 100%
                element.style.fontWeight = 'bold';
                element.title = `${label} = 100% - QUY LU·∫¨T TUY·ªÜT ƒê·ªêI`;
            } else if (numValue >= 70) {
                element.style.color = '#3b82f6'; // Xanh d∆∞∆°ng cho cao
            } else if (numValue <= 30) {
                element.style.color = '#ef4444'; // ƒê·ªè cho th·∫•p
            } else {
                element.style.color = '#9ca3af'; // X√°m cho trung b√¨nh
            }
        }

        // =================== HI·ªÇN TH·ªä PH√ÇN T√çCH CHI TI·∫æT ===================
        function showPatternAnalysis() {
            let analysisHTML = `
                <div class="space-y-6">
                    <h3 class="text-xl font-bold text-yellow-300 text-center">üìä PH√ÇN T√çCH QUY LU·∫¨T CHI TI·∫æT</h3>
                    <p class="text-gray-400 text-center">Ph√¢n t√≠ch quy lu·∫≠t t·ª´ Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá v√† Bi·ªÉu ƒë·ªì k·∫øt h·ª£p c·ªßa 4 h·ªá th·ªëng</p>
            `;
            
            const systems = ['ht1', 'ht2', 'ht3', 'ht4'];
            const systemNames = {
                ht1: 'üî∑ HT1 - Pattern Matching',
                ht2: 'üî∂ HT2 - Fixed & Optimized',
                ht3: 'üî∏ HT3 - Standard System',
                ht4: 'üîπ HT4 - Advanced System'
            };
            
            for (const system of systems) {
                const analysis = masterState.patternAnalysis[system];
                if (!analysis) continue;
                
                analysisHTML += `
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h4 class="text-lg font-bold mb-3 ${system === 'ht1' ? 'text-blue-300' : system === 'ht2' ? 'text-green-300' : system === 'ht3' ? 'text-orange-300' : 'text-pink-300'}">
                            ${systemNames[system]}
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h5 class="font-semibold text-gray-300 mb-2">Bi·ªÉu ƒë·ªì kho·∫£ng t·ª∑ l·ªá</h5>
                                <div class="bg-gray-900 p-3 rounded">
                                    <p class="text-sm text-gray-400 mb-1">Chu·ªói: ${analysis.interval.patternString || 'Ch∆∞a c√≥ d·ªØ li·ªáu'}</p>
                                    <p class="text-sm ${analysis.interval.hasPattern ? (analysis.interval.has100Percent ? 'text-green-400 font-bold' : 'text-green-400') : 'text-red-400'}">
                                        ${analysis.interval.hasPattern ? (analysis.interval.has100Percent ? 'üö® C√ì QUY LU·∫¨T 100%' : '‚úÖ C√ì QUY LU·∫¨T') : '‚ùå KH√îNG C√ì QUY LU·∫¨T'} 
                                        (ƒê·ªô tin c·∫≠y: ${analysis.interval.confidence}%, ƒê·ªô d√†i: ${analysis.interval.length} v√°n)
                                    </p>
                                    <div class="mt-2 text-xs space-y-1">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">D‚ÜíS:</span>
                                            <span class="${analysis.interval.rawRates.DtoS === 100 ? 'font-bold text-green-400' : (analysis.interval.rawRates.DtoS >= 70 || analysis.interval.rawRates.DtoS <= 30 ? 'font-bold text-yellow-300' : 'text-gray-300')}">
                                                ${analysis.interval.rates.DtoS}%
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">S‚ÜíD:</span>
                                            <span class="${analysis.interval.rawRates.StoD === 100 ? 'font-bold text-green-400' : (analysis.interval.rawRates.StoD >= 70 || analysis.interval.rawRates.StoD <= 30 ? 'font-bold text-yellow-300' : 'text-gray-300')}">
                                                ${analysis.interval.rates.StoD}%
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">DD‚ÜíS:</span>
                                            <span class="${analysis.interval.rawRates.DDtoS === 100 ? 'font-bold text-green-400' : (analysis.interval.rawRates.DDtoS >= 70 || analysis.interval.rawRates.DDtoS <= 30 ? 'font-bold text-yellow-300' : 'text-gray-300')}">
                                                ${analysis.interval.rates.DDtoS}%
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">SS‚ÜíD:</span>
                                            <span class="${analysis.interval.rawRates.SStoD === 100 ? 'font-bold text-green-400' : (analysis.interval.rawRates.SStoD >= 70 || analysis.interval.rawRates.SStoD <= 30 ? 'font-bold text-yellow-300' : 'text-gray-300')}">
                                                ${analysis.interval.rates.SStoD}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h5 class="font-semibold text-gray-300 mb-2">Bi·ªÉu ƒë·ªì k·∫øt h·ª£p</h5>
                                <div class="bg-gray-900 p-3 rounded">
                                    <p class="text-sm text-gray-400 mb-1">Chu·ªói: ${analysis.combined.patternString || 'Ch∆∞a c√≥ d·ªØ li·ªáu'}</p>
                                    <p class="text-sm ${analysis.combined.hasPattern ? (analysis.combined.has100Percent ? 'text-green-400 font-bold' : 'text-green-400') : 'text-red-400'}">
                                        ${analysis.combined.hasPattern ? (analysis.combined.has100Percent ? 'üö® C√ì QUY LU·∫¨T 100%' : '‚úÖ C√ì QUY LU·∫¨T') : '‚ùå KH√îNG C√ì QUY LU·∫¨T'} 
                                        (ƒê·ªô tin c·∫≠y: ${analysis.combined.confidence}%, ƒê·ªô d√†i: ${analysis.combined.length} v√°n)
                                    </p>
                                    <div class="mt-2 text-xs space-y-1">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">D‚ÜíS:</span>
                                            <span class="${analysis.combined.rawRates.DtoS === 100 ? 'font-bold text-green-400' : (analysis.combined.rawRates.DtoS >= 70 || analysis.combined.rawRates.DtoS <= 30 ? 'font-bold text-yellow-300' : 'text-gray-300')}">
                                                ${analysis.combined.rates.DtoS}%
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">S‚ÜíD:</span>
                                            <span class="${analysis.combined.rawRates.StoD === 100 ? 'font-bold text-green-400' : (analysis.combined.rawRates.StoD >= 70 || analysis.combined.rawRates.StoD <= 30 ? 'font-bold text-yellow-300' : 'text-gray-300')}">
                                                ${analysis.combined.rates.StoD}%
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">DD‚ÜíS:</span>
                                            <span class="${analysis.combined.rawRates.DDtoS === 100 ? 'font-bold text-green-400' : (analysis.combined.rawRates.DDtoS >= 70 || analysis.combined.rawRates.DDtoS <= 30 ? 'font-bold text-yellow-300' : 'text-gray-300')}">
                                                ${analysis.combined.rates.DDtoS}%
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">SS‚ÜíD:</span>
                                            <span class="${analysis.combined.rawRates.SStoD === 100 ? 'font-bold text-green-400' : (analysis.combined.rawRates.SStoD >= 70 || analysis.combined.rawRates.SStoD <= 30 ? 'font-bold text-yellow-300' : 'text-gray-300')}">
                                                ${analysis.combined.rates.SStoD}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 p-2 bg-gray-900 rounded">
                            <h6 class="font-semibold ${analysis.interval.has100Percent || analysis.combined.has100Percent ? 'text-green-400' : 'text-cyan-400'} text-sm mb-2">Khuy·∫øn ngh·ªã h√†nh ƒë·ªông:</h6>
                            <ul class="text-xs text-gray-300 space-y-1">
                                ${analysis.interval.recommendations.map(rec => `<li>üìä ${rec}</li>`).join('')}
                                ${analysis.combined.recommendations.map(rec => `<li>üîó ${rec}</li>`).join('')}
                                ${analysis.interval.recommendations.length === 0 && analysis.combined.recommendations.length === 0 ? 
                                    '<li>‚è≥ Ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ƒë∆∞a ra khuy·∫øn ngh·ªã</li>' : ''}
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            analysisHTML += `
                    <div class="mt-6 p-4 bg-purple-900 rounded-lg">
                        <h4 class="font-bold text-yellow-300 mb-2">üìù THU·∫¨T TO√ÅN QUY·∫æT ƒê·ªäNH 100%</h4>
                        <ul class="text-sm text-gray-300 space-y-2">
                            <li>‚Ä¢ <span class="text-green-400">D (ƒê√∫ng)</span> - K·∫øt qu·∫£ d·ª± ƒëo√°n ƒë√∫ng</li>
                            <li>‚Ä¢ <span class="text-red-400">S (Sai)</span> - K·∫øt qu·∫£ d·ª± ƒëo√°n sai</li>
                            <li>‚Ä¢ <span class="text-green-400 font-bold">üö® QUY LU·∫¨T 100% L√Ä B·∫ÆT BU·ªòC:</span> Ch·ªâ ƒë∆∞a ra quy·∫øt ƒë·ªãnh khi c√≥ t·ª∑ l·ªá ch√≠nh x√°c 100%</li>
                            <li>‚Ä¢ <span class="text-green-400">D‚ÜíS = 100%</span>: Sau ƒê√öNG LU√îN SAI ‚Üí NG∆Ø·ª¢C v·ªõi d·ª± ƒëo√°n g·ªëc</li>
                            <li>‚Ä¢ <span class="text-green-400">S‚ÜíD = 100%</span>: Sau SAI LU√îN ƒê√öNG ‚Üí THEO d·ª± ƒëo√°n g·ªëc</li>
                            <li>‚Ä¢ <span class="text-green-400">DD‚ÜíS = 100%</span>: Sau 2 ƒê√öNG LU√îN SAI ‚Üí NG∆Ø·ª¢C v·ªõi d·ª± ƒëo√°n g·ªëc</li>
                            <li>‚Ä¢ <span class="text-green-400">SS‚ÜíD = 100%</span>: Sau 2 SAI LU√îN ƒê√öNG ‚Üí THEO d·ª± ƒëo√°n g·ªëc</li>
                            <li>‚Ä¢ <span class="text-blue-300">∆Øu ti√™n quy lu·∫≠t c√≥ chu·ªói d√†i h∆°n (nhi·ªÅu v√°n h∆°n)</span></li>
                            <li>‚Ä¢ <span class="text-red-300 font-bold">N·∫øu kh√¥ng c√≥ quy lu·∫≠t 100% n√†o: ƒê·ªÄ XU·∫§T D·ª™NG L·∫†I HO·∫∂C ƒê·ªîI B√ÄN!</span></li>
                        </ul>
                    </div>
                </div>
            `;
            
            // Hi·ªÉn th·ªã modal
            showModal('Ph√¢n T√≠ch Quy Lu·∫≠t Chi Ti·∫øt', analysisHTML);
        }

        // =================== C·∫¨P NH·∫¨T HI·ªÇN TH·ªä QUY·∫æT ƒê·ªäNH ===================
        function updateFinalDecisionDisplay(decision, reason, prioritySystem) {
            const container = document.getElementById('finalDecisionContainer');
            const text = document.getElementById('finalDecisionText');
            const reasonEl = document.getElementById('decisionReason');
            const priorityEl = document.getElementById('priority-system');
            
            priorityEl.textContent = prioritySystem || 'CH·ªú';
            
            if (decision === 'P') {
                text.textContent = 'üë§ CH·ªêT PLAYER';
                text.className = 'text-3xl md:text-4xl font-extrabold text-blue-400';
                container.className = 'py-6 rounded-lg border-2 border-blue-500 mb-4 bg-blue-900 bg-opacity-20';
            } else if (decision === 'B') {
                text.textContent = 'üè¶ CH·ªêT BANKER';
                text.className = 'text-3xl md:text-4xl font-extrabold text-red-400';
                container.className = 'py-6 rounded-lg border-2 border-red-500 mb-4 bg-red-900 bg-opacity-20';
            } else {
                text.textContent = '‚è≥ CH·ªú T√çN HI·ªÜU';
                text.className = 'text-3xl md:text-4xl font-extrabold text-gray-300';
                container.className = 'py-6 rounded-lg border-2 border-purple-500 mb-4 bg-purple-900 bg-opacity-20';
            }
            
            reasonEl.textContent = reason;
            masterState.lastDecision = decision;
            masterState.lastDecisionReason = reason;
        }

        // =================== TH·ªêNG K√ä V√Ä BI·ªÇU ƒê·ªí CHO QUY·∫æT ƒê·ªäNH CU·ªêI C√ôNG ===================
        function updateFinalDecisionStats() {
            const history = masterState.finalDecisionHistory;
            const totalGames = history.length;
            const correctGames = history.filter(item => item.correct).length;
            const accuracyRate = totalGames > 0 ? ((correctGames / totalGames) * 100).toFixed(1) : 0;
            
            document.getElementById('final-total-games').textContent = totalGames;
            document.getElementById('final-correct-games').textContent = correctGames;
            document.getElementById('final-accuracy-rate').textContent = `${accuracyRate}%`;
            
            updateFinalDecisionChart();
            updateFinalDecisionHistoryTable();
        }

        function updateFinalDecisionChart() {
            const history = masterState.finalDecisionHistory;
            const chartEl = document.getElementById('final-decision-chart');
            
            if (!chartEl) return;
            
            if (!history || history.length === 0) {
                chartEl.innerHTML = '<p class="text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu...</p>';
                return;
            }
            
            let chartHTML = '';
            const recentHistory = history.slice(-30);
            
            recentHistory.forEach((item, index) => {
                const isCorrect = item.correct;
                const barClass = isCorrect ? 'final-decision-correct' : 'final-decision-incorrect';
                const gameNumber = history.length - recentHistory.length + index + 1;
                const title = `V√°n ${gameNumber}: ${item.decision === 'P' ? 'PLAYER' : 'BANKER'} - ${isCorrect ? 'ƒê√öNG' : 'SAI'}`;
                
                chartHTML += `<div class="final-decision-bar ${barClass}" title="${title}"></div>`;
            });
            
            chartEl.innerHTML = chartHTML;
        }

        function updateFinalDecisionHistoryTable() {
            const history = masterState.finalDecisionHistory;
            const tableBody = document.getElementById('final-decision-history-body');
            
            if (!tableBody) return;
            
            if (!history || history.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="p-4 text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu...</td>
                    </tr>`;
                return;
            }
            
            const recentHistory = history.slice(-10).reverse();
            
            let tableHTML = '';
            recentHistory.forEach((item, index) => {
                const gameNumber = history.length - (recentHistory.length - index) + 1;
                const decisionText = item.decision === 'P' ? 'PLAYER' : 'BANKER';
                const actualText = item.actual === 'P' ? 'PLAYER' : 'BANKER';
                const statusClass = item.correct ? 'text-green-400' : 'text-red-400';
                const statusText = item.correct ? 'ƒê√öNG' : 'SAI';
                const shortReason = item.reason.length > 30 ? item.reason.substring(0, 30) + '...' : item.reason;
                
                tableHTML += `
                    <tr class="border-b border-gray-700 hover:bg-gray-700">
                        <td class="p-2">${gameNumber}</td>
                        <td class="p-2 font-medium ${item.decision === 'P' ? 'text-blue-400' : 'text-red-400'}">${decisionText}</td>
                        <td class="p-2 ${item.actual === 'P' ? 'text-blue-400' : 'text-red-400'}">${actualText}</td>
                        <td class="p-2 ${statusClass} font-medium">${statusText}</td>
                        <td class="p-2 text-xs text-gray-400" title="${item.reason}">${shortReason}</td>
                    </tr>`;
            });
            
            tableBody.innerHTML = tableHTML;
        }

        function addFinalDecisionToHistory(actualResult) {
            if (!masterState.lastDecision) return;
            
            const newRecord = {
                gameNumber: masterState.finalDecisionHistory.length + 1,
                decision: masterState.lastDecision,
                actual: actualResult,
                correct: masterState.lastDecision === actualResult,
                reason: masterState.lastDecisionReason || 'Kh√¥ng c√≥ l√Ω do',
                timestamp: Date.now()
            };
            
            masterState.finalDecisionHistory.push(newRecord);
            updateFinalDecisionStats();
            saveFinalDecisionHistory();
        }

        function saveFinalDecisionHistory() {
            try {
                localStorage.setItem('vanSuNhuY_finalDecisionHistory', JSON.stringify(masterState.finalDecisionHistory));
            } catch (e) {
                console.error('Error saving final decision history:', e);
            }
        }

        function loadFinalDecisionHistory() {
            try {
                const saved = localStorage.getItem('vanSuNhuY_finalDecisionHistory');
                if (saved) {
                    masterState.finalDecisionHistory = JSON.parse(saved);
                    updateFinalDecisionStats();
                }
            } catch (e) {
                console.error('Error loading final decision history:', e);
            }
        }

        // =================== IFRAME COMMUNICATION ===================
        function sendToIframe(iframeId, command, data = null) {
            const iframe = document.getElementById(iframeId);
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({
                    command: command,
                    data: data,
                    source: 'master'
                }, '*');
                return true;
            }
            return false;
        }

        function broadcastToAll(command, data = null) {
            sendToIframe('ht1-iframe', command, data);
            sendToIframe('ht2-iframe', command, data);
            sendToIframe('ht3-iframe', command, data);
            sendToIframe('ht4-iframe', command, data);
        }

        // =================== MESSAGE LISTENER ===================
        window.addEventListener('message', function(event) {
            if (event.data.source === 'ht1' || event.data.source === 'ht2' || 
                event.data.source === 'ht3' || event.data.source === 'ht4') {
                handleSystemMessage(event.data);
            }
        });

        function handleSystemMessage(data) {
            const system = data.source;
            
            switch(data.type) {
                case 'ready':
                    masterState.systemsReady[system] = true;
                    updateSystemStatus();
                    if (allSystemsReady()) {
                        initializeSystems();
                    }
                    break;
                    
                case 'accuracy_update':
                    updateSystemAccuracy(system, data.accuracy);
                    break;
                    
                case 'chot_history_update':
                    updateChotHistory(system, data.history);
                    break;
                    
                case 'session_update':
                    updateSessionInfo(system, data.session);
                    break;
                    
                case 'prediction_update':
                    if (data.prediction) {
                        masterState.predictions[system] = data.prediction;
                    }
                    break;

                case 'system_details_update':
                    updateSystemDetails(system, data.details);
                    // T√≠nh to√°n quy·∫øt ƒë·ªãnh cu·ªëi c√πng sau khi nh·∫≠n chi ti·∫øt t·ª´ h·ªá th·ªëng
                    calculateFinalDecision();
                    break;

                case 'import_complete':
                    showToast(`${system.toUpperCase()} ƒë√£ nh·∫≠p d·ªØ li·ªáu xong`, 'success');
                    break;

                case 'export_data':
                    if (data.sessions) {
                        masterState[`${system}Sessions`] = data.sessions;
                    }
                    break;
            }
        }

        // =================== SYSTEM CONTROL ===================
        function toggleFrame(system) {
            const content = document.getElementById(`${system}-content`);
            const icon = document.getElementById(`${system}-toggle-icon`);
            const frame = document.getElementById(`${system}-frame`);
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.setAttribute('d', 'M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z');
                frame.classList.remove('active');
            } else {
                content.style.display = 'none';
                icon.setAttribute('d', 'M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z');
                frame.classList.add('active');
            }
        }

        function showAllFrames() {
            ['ht1', 'ht2', 'ht3', 'ht4'].forEach(system => {
                const content = document.getElementById(`${system}-content`);
                const icon = document.getElementById(`${system}-toggle-icon`);
                const frame = document.getElementById(`${system}-frame`);
                
                content.style.display = 'block';
                icon.setAttribute('d', 'M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z');
                frame.classList.remove('active');
            });
        }

        function hideAllFrames() {
            ['ht1', 'ht2', 'ht3', 'ht4'].forEach(system => {
                const content = document.getElementById(`${system}-content`);
                const icon = document.getElementById(`${system}-toggle-icon`);
                const frame = document.getElementById(`${system}-frame`);
                
                content.style.display = 'none';
                icon.setAttribute('d', 'M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z');
                frame.classList.add('active');
            });
        }

        function allSystemsReady() {
            return masterState.systemsReady.ht1 && 
                   masterState.systemsReady.ht2 && 
                   masterState.systemsReady.ht3 && 
                   masterState.systemsReady.ht4;
        }

        function updateSystemStatus() {
            ['ht1', 'ht2', 'ht3', 'ht4'].forEach(system => {
                const element = document.getElementById(`${system}-status`);
                if (element) {
                    element.textContent = masterState.systemsReady[system] ? 'üü¢ ƒêang ho·∫°t ƒë·ªông' : 'üü° ƒêang kh·ªüi ƒë·ªông';
                }
            });
            
            if (allSystemsReady()) {
                document.getElementById('sync-status').textContent = 'üü¢ ƒê√£ ƒë·ªìng b·ªô';
                document.getElementById('sync-status').className = 'text-green-400 font-semibold';
            }
        }

        // =================== SESSION MANAGEMENT ===================
        function initializeSystems() {
            loadMasterSessions();
            loadFinalDecisionHistory();
            
            setTimeout(() => {
                broadcastToAll('get_accuracy');
                broadcastToAll('get_session_info');
                broadcastToAll('get_chot_history');
                broadcastToAll('get_prediction');
                broadcastToAll('get_system_details');
            }, 1500);
        }

        function loadMasterSessions() {
            try {
                const saved = localStorage.getItem('vanSuNhuY_sessions_v2');
                if (saved) {
                    masterState.sessions = JSON.parse(saved);
                    updateMasterSessionSelector();
                }
            } catch (e) {
                console.error('Error loading master sessions:', e);
            }
        }

        function saveMasterSessions() {
            localStorage.setItem('vanSuNhuY_sessions_v2', JSON.stringify(masterState.sessions));
        }

        function updateMasterSessionSelector() {
            const selector = document.getElementById('masterSessionSelector');
            selector.innerHTML = '<option value="">Ch·ªçn phi√™n ƒë·ªÉ ƒë·ªìng b·ªô...</option>';
            
            Object.keys(masterState.sessions).forEach(sessionId => {
                const option = document.createElement('option');
                option.value = sessionId;
                option.textContent = masterState.sessions[sessionId].name;
                selector.appendChild(option);
            });
        }

        function createNewSessionAll() {
            const sessionName = prompt('Nh·∫≠p t√™n phi√™n m·ªõi:', `Phi√™n ${new Date().toLocaleString('vi-VN')}`);
            if (sessionName) {
                const sessionId = `session-${Date.now()}`;
                
                masterState.sessions[sessionId] = {
                    id: sessionId,
                    name: sessionName,
                    created: new Date().toISOString(),
                    history: []
                };
                
                masterState.currentSessionId = sessionId;
                masterState.currentSessionName = sessionName;
                
                saveMasterSessions();
                updateMasterSessionSelector();
                updateCurrentSessionInfo();
                
                broadcastToAll('create_session', {
                    name: sessionName,
                    id: sessionId
                });
                
                showToast(`ƒê√£ t·∫°o phi√™n m·ªõi: ${sessionName}`, 'success');
            }
        }

        function renameMasterSession() {
            if (!masterState.currentSessionId) {
                showToast('Vui l√≤ng ch·ªçn phi√™n tr∆∞·ªõc!', 'warning');
                return;
            }
            
            const newName = prompt('Nh·∫≠p t√™n m·ªõi cho phi√™n:', masterState.currentSessionName);
            if (newName) {
                masterState.sessions[masterState.currentSessionId].name = newName;
                masterState.currentSessionName = newName;
                
                saveMasterSessions();
                updateMasterSessionSelector();
                updateCurrentSessionInfo();
                
                broadcastToAll('rename_session', {
                    id: masterState.currentSessionId,
                    name: newName
                });
                
                showToast(`ƒê√£ ƒë·ªïi t√™n phi√™n th√†nh: ${newName}`, 'success');
            }
        }

        function updateCurrentSessionInfo() {
            document.getElementById('currentSessionName').textContent = masterState.currentSessionName;
            
            const session = masterState.sessions[masterState.currentSessionId];
            if (session && session.history) {
                document.getElementById('totalGamesMaster').textContent = session.history.length;
            }
        }

        // =================== DATA IMPORT/EXPORT ===================
        function exportMasterData() {
            return new Promise((resolve) => {
                const exportData = {
                    type: 'vanSuNhuY_export',
                    version: '3.0',
                    timestamp: new Date().toISOString(),
                    sessions: masterState.sessions,
                    finalDecisionHistory: masterState.finalDecisionHistory,
                    system_sessions: {
                        ht1: null,
                        ht2: null,
                        ht3: null,
                        ht4: null
                    }
                };

                let systemsCollected = 0;
                const totalSystems = 4;

                function handleSystemResponse(event) {
                    if (event.data.source && event.data.type === 'export_data') {
                        const system = event.data.source;
                        exportData.system_sessions[system] = event.data.sessions;
                        systemsCollected++;

                        if (systemsCollected === totalSystems) {
                            window.removeEventListener('message', handleSystemResponse);
                            
                            const dataStr = JSON.stringify(exportData, null, 2);
                            const dataBlob = new Blob([dataStr], {type: 'application/json'});
                            const url = URL.createObjectURL(dataBlob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `VanSuNhuY_4Systems_Export_${new Date().toISOString().slice(0,10)}.json`;
                            link.click();
                            URL.revokeObjectURL(url);
                            
                            showToast('ƒê√£ xu·∫•t d·ªØ li·ªáu t·ªïng h·ª£p 4 h·ªá th·ªëng', 'success');
                            resolve(true);
                        }
                    }
                }

                window.addEventListener('message', handleSystemResponse);
                broadcastToAll('export_data');

                setTimeout(() => {
                    if (systemsCollected < totalSystems) {
                        showToast(`Ch·ªâ thu th·∫≠p ƒë∆∞·ª£c ${systemsCollected}/4 h·ªá th·ªëng. Xu·∫•t d·ªØ li·ªáu kh√¥ng ƒë·∫ßy ƒë·ªß.`, 'warning');
                        
                        const dataStr = JSON.stringify(exportData, null, 2);
                        const dataBlob = new Blob([dataStr], {type: 'application/json'});
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `VanSuNhuY_4Systems_Export_${new Date().toISOString().slice(0,10)}.json`;
                        link.click();
                        URL.revokeObjectURL(url);
                        
                        window.removeEventListener('message', handleSystemResponse);
                        resolve(true);
                    }
                }, 5000);
            });
        }

        function importMasterData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.type === 'vanSuNhuY_export') {
                        if (data.sessions) {
                            masterState.sessions = data.sessions;
                            saveMasterSessions();
                            updateMasterSessionSelector();
                        }
                        
                        if (data.finalDecisionHistory) {
                            masterState.finalDecisionHistory = data.finalDecisionHistory;
                            saveFinalDecisionHistory();
                            updateFinalDecisionStats();
                        }
                        
                        const hasSystemData = data.system_sessions && 
                            (data.system_sessions.ht1 || data.system_sessions.ht2 || 
                             data.system_sessions.ht3 || data.system_sessions.ht4);
                        
                        if (!hasSystemData) {
                            showToast('File kh√¥ng c√≥ d·ªØ li·ªáu ri√™ng c·ªßa t·ª´ng h·ªá th·ªëng. Ch·ªâ import d·ªØ li·ªáu t·ªïng h·ª£p.', 'warning');
                        }
                        
                        showLoadingModal('ƒêang nh·∫≠p d·ªØ li·ªáu v√†o 4 h·ªá th·ªëng...');
                        
                        setTimeout(() => {
                            ['ht1', 'ht2', 'ht3', 'ht4'].forEach(system => {
                                const systemData = data.system_sessions?.[system] || data.sessions;
                                sendToIframe(`${system}-iframe`, 'import_data', {
                                    sessions: systemData,
                                    simulate: true,
                                    isMasterData: !data.system_sessions?.[system]
                                });
                            });
                            
                            setTimeout(() => {
                                hideLoadingModal();
                                showToast('ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng v√†o 4 h·ªá th·ªëng!', 'success');
                                
                                setTimeout(() => {
                                    broadcastToAll('get_accuracy');
                                    broadcastToAll('get_session_info');
                                    broadcastToAll('get_chot_history');
                                    broadcastToAll('get_system_details');
                                    updateFinalDecisionStats();
                                }, 1000);
                                
                            }, 2000);
                            
                        }, 500);
                        
                    } else {
                        showToast('File c≈© - G·ª≠i c√πng d·ªØ li·ªáu cho t·∫•t c·∫£ h·ªá th·ªëng', 'info');
                        broadcastToAll('import_data', {
                            sessions: data,
                            simulate: true,
                            isMasterData: true
                        });
                    }
                } catch (error) {
                    hideLoadingModal();
                    showToast('L·ªói khi ƒë·ªçc file d·ªØ li·ªáu', 'error');
                    console.error('Import error:', error);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // =================== INPUT HANDLING ===================
        function addResultToAll(result) {
            if (!masterState.currentSessionId) {
                showToast('Vui l√≤ng ch·ªçn ho·∫∑c t·∫°o phi√™n tr∆∞·ªõc!', 'warning');
                return;
            }
            
            const session = masterState.sessions[masterState.currentSessionId];
            if (!session.history) session.history = [];
            session.history.push(result);
            
            saveMasterSessions();
            updateCurrentSessionInfo();
            
            broadcastToAll('add_result', result);
            
            addFinalDecisionToHistory(result);
            
            setTimeout(() => {
                broadcastToAll('get_accuracy');
                broadcastToAll('get_chot_history');
                broadcastToAll('get_prediction');
                broadcastToAll('get_system_details');
            }, 800);
            
            showToast(`ƒê√£ th√™m k·∫øt qu·∫£: ${result === 'P' ? 'PLAYER' : 'BANKER'} ƒë·∫øn 4 h·ªá th·ªëng`, 'success');
        }

        function undoLastAll() {
            if (!masterState.currentSessionId) {
                showToast('Kh√¥ng c√≥ phi√™n n√†o ƒëang ho·∫°t ƒë·ªông!', 'warning');
                return;
            }
            
            const session = masterState.sessions[masterState.currentSessionId];
            if (session.history.length === 0) {
                showToast('Kh√¥ng c√≥ k·∫øt qu·∫£ ƒë·ªÉ ho√†n t√°c!', 'warning');
                return;
            }
            
            session.history.pop();
            saveMasterSessions();
            updateCurrentSessionInfo();
            
            broadcastToAll('undo_last');
            
            if (masterState.finalDecisionHistory.length > 0) {
                masterState.finalDecisionHistory.pop();
                updateFinalDecisionStats();
                saveFinalDecisionHistory();
            }
            
            setTimeout(() => {
                broadcastToAll('get_accuracy');
                broadcastToAll('get_chot_history');
                broadcastToAll('get_system_details');
            }, 800);
            
            showToast('ƒê√£ ho√†n t√°c k·∫øt qu·∫£ cu·ªëi c√πng t·ª´ 4 h·ªá th·ªëng', 'info');
        }

        function clearHistoryAll() {
            if (!masterState.currentSessionId) {
                showToast('Kh√¥ng c√≥ phi√™n n√†o ƒëang ho·∫°t ƒë·ªông!', 'warning');
                return;
            }
            
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ c·ªßa phi√™n n√†y?')) {
                masterState.sessions[masterState.currentSessionId].history = [];
                saveMasterSessions();
                updateCurrentSessionInfo();
                
                broadcastToAll('clear_history');
                
                masterState.finalDecisionHistory = [];
                updateFinalDecisionStats();
                saveFinalDecisionHistory();
                
                masterState.displayedWarnings = {};
                
                showToast('ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠ t·ª´ 4 h·ªá th·ªëng', 'info');
            }
        }

        function syncAllSystems() {
            if (!masterState.currentSessionId) {
                showToast('Vui l√≤ng ch·ªçn phi√™n tr∆∞·ªõc khi ƒë·ªìng b·ªô!', 'warning');
                return;
            }
            
            const session = masterState.sessions[masterState.currentSessionId];
            
            broadcastToAll('load_session', {
                id: masterState.currentSessionId,
                name: session.name,
                history: session.history
            });
            
            document.getElementById('sync-status').textContent = 'üîÑ ƒêang ƒë·ªìng b·ªô...';
            document.getElementById('sync-status').className = 'text-yellow-400 font-semibold';
            
            setTimeout(() => {
                document.getElementById('sync-status').textContent = 'üü¢ ƒê√£ ƒë·ªìng b·ªô';
                document.getElementById('sync-status').className = 'text-green-400 font-semibold';
                showToast('ƒê√£ ƒë·ªìng b·ªô 4 h·ªá th·ªëng', 'success');
                
                setTimeout(() => {
                    broadcastToAll('get_accuracy');
                    broadcastToAll('get_chot_history');
                    broadcastToAll('get_prediction');
                    broadcastToAll('get_system_details');
                }, 1000);
            }, 1500);
        }

        function resetAllSystems() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën reset t·∫•t c·∫£ 4 h·ªá th·ªëng v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu?')) {
                masterState.sessions = {};
                masterState.currentSessionId = null;
                masterState.currentSessionName = 'Ch∆∞a ch·ªçn';
                masterState.ht1Accuracy = 0;
                masterState.ht2Accuracy = 0;
                masterState.ht3Accuracy = 0;
                masterState.ht4Accuracy = 0;
                masterState.systemDetails = {
                    ht1: { verdict: null, chot: null, range: null, rangeAccuracy: null, intervalHistory: [] },
                    ht2: { verdict: null, chot: null, range: null, rangeAccuracy: null, intervalHistory: [] },
                    ht3: { verdict: null, chot: null, range: null, rangeAccuracy: null, intervalHistory: [] },
                    ht4: { verdict: null, chot: null, range: null, rangeAccuracy: null, intervalHistory: [] }
                };
                
                masterState.finalDecisionHistory = [];
                masterState.displayedWarnings = {};
                masterState.patternAnalysis = {
                    ht1: { interval: null, combined: null },
                    ht2: { interval: null, combined: null },
                    ht3: { interval: null, combined: null },
                    ht4: { interval: null, combined: null }
                };
                
                localStorage.removeItem('vanSuNhuY_sessions_v2');
                localStorage.removeItem('vanSuNhuY_finalDecisionHistory');
                updateMasterSessionSelector();
                updateCurrentSessionInfo();
                
                broadcastToAll('reset_system');
                
                resetCharts();
                updateFinalDecisionStats();
                
                document.getElementById('warning-container').innerHTML = '';
                
                showToast('ƒê√£ reset t·∫•t c·∫£ 4 h·ªá th·ªëng', 'info');
            }
        }

        // =================== ACCURACY & DECISION CALCULATION ===================
        function updateSystemAccuracy(system, accuracy) {
            masterState[`${system}Accuracy`] = accuracy;
            
            const element = document.getElementById(`${system}-accuracy`);
            const display = document.getElementById(`accuracy-${system}-display`);
            
            if (element) element.textContent = `${accuracy.toFixed(1)}%`;
            if (display) display.textContent = `${accuracy.toFixed(1)}%`;
            
            if (element) {
                element.className = 'accuracy-badge ';
                if (accuracy >= 70) {
                    element.className += 'accuracy-high';
                } else if (accuracy >= 50) {
                    element.className += 'accuracy-medium';
                } else {
                    element.className += 'accuracy-low';
                }
            }
        }

        function updateChotHistory(system, history) {
            masterState[`${system}ChotHistory`] = history;
            renderCombinedChart(system);
        }

        function updateSessionInfo(system, sessionInfo) {
            if (sessionInfo && sessionInfo.id) {
                if (!masterState.sessions[sessionInfo.id]) {
                    masterState.sessions[sessionInfo.id] = {
                        id: sessionInfo.id,
                        name: sessionInfo.name || `Phi√™n ${sessionInfo.id}`,
                        history: sessionInfo.history || [],
                        systemData: {
                            ...(masterState.sessions[sessionInfo.id]?.systemData || {}),
                            [system]: sessionInfo
                        }
                    };
                }
                
                if (sessionInfo.current) {
                    masterState.currentSessionId = sessionInfo.id;
                    masterState.currentSessionName = sessionInfo.name;
                    updateCurrentSessionInfo();
                    updateMasterSessionSelector();
                }
                
                saveMasterSessions();
            }
        }

        function updateSystemDetails(system, details) {
            if (!details) return;
            
            masterState.systemDetails[system] = {
                verdict: details.verdict || null,
                chot: details.chot || null,
                range: details.range || null,
                rangeAccuracy: details.rangeAccuracy || null,
                intervalHistory: details.intervalHistory || []
            };
            
            updateSystemDetailsUI(system);
        }

        function updateSystemDetailsUI(system) {
            const details = masterState.systemDetails[system];
            if (!details) return;
            
            const verdictElement = document.getElementById(`${system}-verdict-prediction`);
            const chotElement = document.getElementById(`${system}-chot-prediction`);
            const rangeElement = document.getElementById(`${system}-confidence-range`);
            const rangeAccuracyElement = document.getElementById(`${system}-range-accuracy`);
            
            if (verdictElement) {
                verdictElement.textContent = details.verdict || '-';
                verdictElement.className = `font-bold text-xl ${details.verdict === 'P' ? 'text-blue-400' : details.verdict === 'B' ? 'text-red-400' : 'text-gray-400'}`;
            }
            
            if (chotElement) {
                chotElement.textContent = details.chot || '-';
                chotElement.className = `font-bold text-xl ${details.chot === 'P' ? 'text-blue-400' : details.chot === 'B' ? 'text-red-400' : 'text-gray-400'}`;
            }
            
            if (rangeElement) {
                rangeElement.textContent = details.range || '-';
            }
            
            if (rangeAccuracyElement) {
                rangeAccuracyElement.textContent = details.rangeAccuracy ? `${details.rangeAccuracy}%` : '-';
            }
            
            updateIntervalChart(system, details.intervalHistory);
            renderCombinedChart(system);
        }

        function updateIntervalChart(system, history) {
            const chartEl = document.getElementById(`${system}-interval-chart`);
            const rangeGamesEl = document.getElementById(`${system}-range-games`);
            
            if (!chartEl) return;
            
            if (!history || history.length === 0) {
                chartEl.innerHTML = '<p class="text-gray-600 text-xs text-center w-full">Ch∆∞a c√≥ d·ªØ li·ªáu...</p>';
                if (rangeGamesEl) rangeGamesEl.textContent = '0 v√°n';
                return;
            }
            
            let chartHTML = '';
            let correctCount = 0;
            let totalCount = history.length;
            
            history.forEach(prediction => {
                const isCorrect = prediction.isCorrect || 
                                 (prediction.predicted === prediction.actual) || 
                                 (prediction.correct === true);
                if (isCorrect) correctCount++;
                const barClass = isCorrect ? 'history-bar-correct' : 'history-bar-incorrect';
                const title = `V√°n: ${prediction.game || 'N/A'} | ƒê·ªÅ xu·∫•t: ${prediction.predicted} | Th·ª±c t·∫ø: ${prediction.actual}`;
                chartHTML += `<div class="history-bar ${barClass}" title="${title}"></div>`;
            });
            
            chartEl.innerHTML = chartHTML;
            
            if (rangeGamesEl) {
                const accuracy = totalCount > 0 ? ((correctCount / totalCount) * 100).toFixed(1) : 0;
                rangeGamesEl.textContent = `${totalCount} v√°n (${correctCount} ƒë√∫ng - ${accuracy}%)`;
            }
        }

        function renderCombinedChart(system) {
            const history = masterState[`${system}ChotHistory`];
            const chartEl = document.getElementById(`${system}-combined-chart`);
            
            if (!chartEl) return;
            
            if (!history || history.length === 0) {
                chartEl.innerHTML = `<p class="text-gray-600 text-xs text-center w-full">Ch∆∞a c√≥ d·ªØ li·ªáu...</p>`;
                return;
            }
            
            const recentHistory = history.slice(-30);
            let chartHTML = '';
            
            recentHistory.forEach(prediction => {
                if (prediction && prediction.predicted !== undefined && prediction.actual !== undefined) {
                    const isCorrect = prediction.predicted === prediction.actual;
                    const barClass = isCorrect ? 'history-bar-correct' : 'history-bar-incorrect';
                    const title = `ƒê·ªÅ xu·∫•t: ${prediction.predicted}, Th·ª±c t·∫ø: ${prediction.actual}`;
                    chartHTML += `<div class="history-bar ${barClass}" title="${title}"></div>`;
                } else if (prediction && prediction.prediction) {
                    const isCorrect = prediction.correct;
                    const barClass = isCorrect ? 'history-bar-correct' : 'history-bar-incorrect';
                    chartHTML += `<div class="history-bar ${barClass}" title="Prediction"></div>`;
                }
            });
            
            chartEl.innerHTML = chartHTML;
        }

        function forcePlayerDecision() {
            updateFinalDecisionDisplay('P', 'Quy·∫øt ƒë·ªãnh th·ªß c√¥ng: CH·ªêT PLAYER', 'TH·ª¶ C√îNG');
            showToast('ƒê√£ ch·ªët PLAYER (th·ªß c√¥ng)', 'info');
        }

        function forceBankerDecision() {
            updateFinalDecisionDisplay('B', 'Quy·∫øt ƒë·ªãnh th·ªß c√¥ng: CH·ªêT BANKER', 'TH·ª¶ C√îNG');
            showToast('ƒê√£ ch·ªët BANKER (th·ªß c√¥ng)', 'info');
        }

        // =================== UI UTILITIES ===================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const colors = {
                success: 'border-green-500',
                info: 'border-blue-500',
                warning: 'border-yellow-500',
                error: 'border-red-500'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast-notification ${colors[type]}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        function showLoadingModal(message) {
            const container = document.getElementById('modal-container');
            container.innerHTML = `
                <div id="loading-modal" class="modal-backdrop">
                    <div class="modal-content text-center">
                        <p class="text-lg text-gray-200">${message}</p>
                        <div class="mt-4">
                            <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                </div>`;
        }

        function hideLoadingModal() {
            const modal = document.getElementById('loading-modal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    document.getElementById('modal-container').innerHTML = '';
                }, 300);
            } else {
                document.getElementById('modal-container').innerHTML = '';
            }
        }

        function showModal(title, content) {
            const modalContainer = document.getElementById('modal-container');
            
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-yellow-300">${title}</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white">
                            ‚úï
                        </button>
                    </div>
                    <div class="text-gray-300">
                        ${content}
                    </div>
                    <div class="mt-6 text-center">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white font-medium">
                            ƒê√≥ng
                        </button>
                    </div>
                </div>
            `;
            
            modalContainer.appendChild(modal);
        }

        function resetCharts() {
            if (gameAccuracyChart) {
                gameAccuracyChart.destroy();
                gameAccuracyChart = null;
            }
        }

        // =================== INITIALIZATION ===================
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentSessionInfo();
            updateSystemStatus();
            updateFinalDecisionStats();
            
            document.getElementById('masterSessionSelector').addEventListener('change', function(e) {
                if (e.target.value) {
                    const sessionId = e.target.value;
                    const session = masterState.sessions[sessionId];
                    
                    if (session) {
                        masterState.currentSessionId = sessionId;
                        masterState.currentSessionName = session.name;
                        updateCurrentSessionInfo();
                        syncAllSystems();
                    }
                }
            });
            
            setInterval(() => {
                if (allSystemsReady()) {
                    broadcastToAll('get_accuracy');
                    broadcastToAll('get_chot_history');
                    broadcastToAll('get_system_details');
                }
            }, 8000);
            
            showToast('H·ªá th·ªëng V·∫†N S·ª∞ NH∆Ø √ù (4 h·ªá th·ªëng) ƒë√£ s·∫µn s√†ng v·ªõi thu·∫≠t to√°n ph√¢n t√≠ch quy lu·∫≠t 100%!', 'success');
        });
    </script>
</body>
</html>
