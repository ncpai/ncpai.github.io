<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nh√† Nghi√™n C·ª©u AI - H·ªá Th·ªëng T√¨m Ki·∫øm Quy Lu·∫≠t</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #F9FAFB;
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .card {
            background-color: #1F2937;
            border: 1px solid #374151;
        }
        .progress-bar-container {
            background-color: #374151;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            background-color: #4f46e5;
            transition: width 0.5s ease-in-out;
        }
        .log-item {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .blinking-cursor {
            font-weight: bold;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { color: transparent }
            50% { color: #60A5FA; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-4xl mx-auto space-y-6">

    <!-- Header -->
    <div class="text-center p-6">
        <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">Nh√† Nghi√™n C·ª©u AI</h1>
        <p class="text-gray-400 mt-2">T·ª± ƒë·ªông ph√¢n t√≠ch, t√¨m ki·∫øm v√† t·ªëi ∆∞u h√≥a quy lu·∫≠t t·ª´ d·ªØ li·ªáu c·ªßa b·∫°n.</p>
    </div>

    <!-- Step 1: Input -->
    <div class="card p-6 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 text-cyan-300 flex items-center">
            <span class="bg-cyan-500 text-gray-900 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">1</span>
            Cung c·∫•p D·ªØ li·ªáu & C√¥ng c·ª•
        </h2>
        
        <div class="space-y-4">
            <div>
                <label for="geminiApiKey" class="block text-sm font-medium text-gray-300 mb-2">Gemini API Key</label>
                <input type="password" id="geminiApiKey" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Nh·∫≠p API Key c·ªßa b·∫°n...">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">T·ªáp D·ªØ Li·ªáu L·ªãch S·ª≠ (.json)</label>
                <div class="flex items-center">
                    <label for="fileInput" class="btn w-full text-center bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg cursor-pointer">
                        üì§ T·∫£i L√™n "S√°ch Gi√°o Khoa"
                    </label>
                    <input type="file" id="fileInput" class="hidden" accept=".json">
                    <span id="fileName" class="ml-4 text-gray-400 truncate">Ch∆∞a c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Analysis -->
    <div class="card p-6 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 text-indigo-300 flex items-center">
            <span class="bg-indigo-500 text-gray-900 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">2</span>
            B·∫Øt ƒë·∫ßu qu√° tr√¨nh Nghi√™n C·ª©u
        </h2>
        <button id="startButton" onclick="startAnalysis()" class="btn w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg text-lg" disabled>
            B·∫Øt ƒë·∫ßu Ph√¢n t√≠ch
        </button>
        
        <div id="analysis-progress" class="mt-6 space-y-4 hidden">
            <div class="flex justify-between items-center text-sm font-medium">
                <span id="statusText" class="text-gray-300">ƒêang chu·∫©n b·ªã...</span>
                <span id="progressText" class="text-indigo-400 font-bold">0%</span>
            </div>
            <div class="progress-bar-container w-full h-2.5">
                <div id="progressBar" class="progress-bar h-2.5" style="width: 0%"></div>
            </div>
             <div id="log-container" class="mt-4 bg-gray-900 p-4 rounded-lg h-48 overflow-y-auto font-mono text-sm text-gray-300">
                <p>Kh·ªüi t·∫°o m√¥i tr∆∞·ªùng nghi√™n c·ª©u... <span class="blinking-cursor">_</span></p>
             </div>
        </div>
    </div>

    <!-- Step 3: Output -->
    <div id="results-card" class="card p-6 rounded-2xl shadow-lg hidden">
         <h2 class="text-2xl font-semibold mb-4 text-green-300 flex items-center">
            <span class="bg-green-500 text-gray-900 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">3</span>
            C√¥ng Tr√¨nh Nghi√™n C·ª©u Ho√†n T·∫•t
        </h2>
        <div id="final-stats" class="mb-4 bg-gray-800 p-4 rounded-lg text-center">
             <p class="text-lg">ƒê·ªô ch√≠nh x√°c cu·ªëi c√πng ƒë√£ ƒë∆∞·ª£c ki·ªÉm ch·ª©ng:</p>
             <p id="finalAccuracy" class="text-4xl font-bold text-green-400 mt-1">0.0%</p>
        </div>
        <div class="bg-gray-900 p-4 rounded-lg">
            <h3 class="font-semibold text-lg mb-2 text-gray-300">Quy lu·∫≠t & Ph∆∞∆°ng ph√°p ƒë∆∞·ª£c t√¨m th·∫•y:</h3>
            <pre id="finalRules" class="whitespace-pre-wrap text-gray-400 text-sm"></pre>
        </div>
        <button onclick="downloadResults()" class="btn w-full mt-6 bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg text-lg">
            üì• T·∫£i V·ªÅ C√¥ng Tr√¨nh Nghi√™n C·ª©u
        </button>
    </div>

</div>

<script>
let state = {
    apiKey: '',
    fullHistory: [],
    bestRuleset: {
        rules: '',
        accuracy: 0,
        explanation: ''
    },
    isAnalyzing: false,
    maxIterations: 5, // Limit iterations to prevent high costs
    currentIteration: 0
};

// --- UI Management ---
const fileInput = document.getElementById('fileInput');
const fileNameEl = document.getElementById('fileName');
const startButton = document.getElementById('startButton');
const apiKeyInput = document.getElementById('geminiApiKey');
const analysisProgressEl = document.getElementById('analysis-progress');
const resultsCardEl = document.getElementById('results-card');
const logContainer = document.getElementById('log-container');
const statusTextEl = document.getElementById('statusText');
const progressBarEl = document.getElementById('progressBar');
const progressTextEl = document.getElementById('progressText');

fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        fileNameEl.textContent = fileInput.files[0].name;
        checkCanStart();
    }
});
apiKeyInput.addEventListener('input', checkCanStart);

function checkCanStart() {
    startButton.disabled = !(apiKeyInput.value.trim() && fileInput.files.length > 0);
}

function logMessage(message) {
    // Remove the blinking cursor if it exists
    const cursor = logContainer.querySelector('.blinking-cursor');
    if (cursor) {
        cursor.parentElement.remove();
    }
    
    const p = document.createElement('p');
    p.className = 'log-item';
    p.innerHTML = `${message} <span class="blinking-cursor">_</span>`;
    logContainer.appendChild(p);
    logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll
}

function updateProgress(percentage, status) {
    percentage = Math.min(100, Math.max(0, percentage));
    progressBarEl.style.width = `${percentage}%`;
    progressTextEl.textContent = `${Math.round(percentage)}%`;
    statusTextEl.textContent = status;
}

// --- Core Logic ---
async function startAnalysis() {
    if (state.isAnalyzing) return;
    
    state.apiKey = apiKeyInput.value.trim();
    const file = fileInput.files[0];
    if (!state.apiKey || !file) {
        alert('Vui l√≤ng nh·∫≠p API Key v√† ch·ªçn t·ªáp d·ªØ li·ªáu.');
        return;
    }

    state.isAnalyzing = true;
    startButton.disabled = true;
    resultsCardEl.classList.add('hidden');
    analysisProgressEl.classList.remove('hidden');
    logContainer.innerHTML = '<p>Kh·ªüi t·∫°o m√¥i tr∆∞·ªùng nghi√™n c·ª©u... <span class="blinking-cursor">_</span></p>';
    state.bestRuleset = { rules: '', accuracy: 0, explanation: '' };
    state.currentIteration = 0;

    try {
        logMessage('ƒêang ƒë·ªçc v√† h·ª£p nh·∫•t d·ªØ li·ªáu...');
        updateProgress(5, 'ƒê·ªçc d·ªØ li·ªáu...');
        const fileContent = await file.text();
        const importedSessions = JSON.parse(fileContent);
        state.fullHistory = Object.values(importedSessions).flatMap(s => s.history || []);
        
        if (state.fullHistory.length < 50) {
            throw new Error('D·ªØ li·ªáu qu√° ng·∫Øn. C·∫ßn √≠t nh·∫•t 50 v√°n c∆∞·ª£c tr√™n t·∫•t c·∫£ c√°c phi√™n.');
        }

        logMessage(`T·ªïng h·ª£p th√†nh c√¥ng ${state.fullHistory.length} v√°n c∆∞·ª£c. B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p nghi√™n c·ª©u.`);
        updateProgress(10, 'B·∫Øt ƒë·∫ßu nghi√™n c·ª©u...');
        
        await analysisLoop();

    } catch (error) {
        logMessage(`L·ªñI: ${error.message}`);
        alert(`ƒê√£ x·∫£y ra l·ªói: ${error.message}`);
    } finally {
        state.isAnalyzing = false;
        startButton.disabled = false;
    }
}

async function analysisLoop() {
    state.currentIteration++;
    if (state.currentIteration > state.maxIterations) {
        logMessage('ƒê√£ ƒë·∫°t s·ªë v√≤ng l·∫∑p t·ªëi ƒëa. Ho√†n t·∫•t nghi√™n c·ª©u.');
        finalizeAnalysis();
        return;
    }
    
    const progressStart = 10 + (state.currentIteration - 1) * 18;
    updateProgress(progressStart, `V√≤ng nghi√™n c·ª©u ${state.currentIteration}/${state.maxIterations}...`);
    logMessage(`--- B·∫Øt ƒë·∫ßu v√≤ng nghi√™n c·ª©u ${state.currentIteration} ---`);

    const { systemPrompt, userQuery } = constructPrompt(state.currentIteration, state.bestRuleset, state.fullHistory);

    logMessage('G·ª≠i y√™u c·∫ßu ph√¢n t√≠ch ƒë·∫øn Gemini...');
    const responseJson = await callGemini(systemPrompt, userQuery);

    const rulesetText = responseJson?.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!rulesetText) {
        throw new Error('Ph·∫£n h·ªìi t·ª´ AI kh√¥ng h·ª£p l·ªá.');
    }
    
    const parsedRules = JSON.parse(rulesetText);
    
    logMessage('ƒê√£ nh·∫≠n b·ªô quy lu·∫≠t m·ªõi. B·∫Øt ƒë·∫ßu ki·ªÉm ch·ª©ng...');
    updateProgress(progressStart + 9, `Ki·ªÉm ch·ª©ng b·ªô quy lu·∫≠t ${state.currentIteration}...`);

    const { accuracy, correct, total } = await verifyRuleset(parsedRules.rules);
    
    logMessage(`Ki·ªÉm ch·ª©ng ho√†n t·∫•t: ƒê·ªô ch√≠nh x√°c ${accuracy.toFixed(2)}% (${correct}/${total}).`);

    if (accuracy > state.bestRuleset.accuracy) {
        logMessage(`T√¨m th·∫•y b·ªô quy lu·∫≠t t·ªët h∆°n! ƒê·ªô ch√≠nh x√°c tƒÉng t·ª´ ${state.bestRuleset.accuracy.toFixed(2)}% l√™n ${accuracy.toFixed(2)}%.`);
        state.bestRuleset = {
            rules: parsedRules.rules,
            explanation: parsedRules.explanation,
            accuracy: accuracy
        };
    } else {
        logMessage(`B·ªô quy lu·∫≠t m·ªõi kh√¥ng hi·ªáu qu·∫£ h∆°n. Gi·ªØ l·∫°i b·ªô quy lu·∫≠t t·ªët nh·∫•t hi·ªán t·∫°i.`);
    }

    if (state.bestRuleset.accuracy > 95) {
         logMessage('ƒê·ªô ch√≠nh x√°c ƒë√£ v∆∞·ª£t 95%. Ho√†n t·∫•t nghi√™n c·ª©u.');
         finalizeAnalysis();
         return;
    }

    await analysisLoop();
}

function finalizeAnalysis() {
    updateProgress(100, "Ho√†n t·∫•t!");
    document.getElementById('finalAccuracy').textContent = `${state.bestRuleset.accuracy.toFixed(2)}%`;
    document.getElementById('finalRules').textContent = state.bestRuleset.explanation;
    resultsCardEl.classList.remove('hidden');
    analysisProgressEl.classList.add('hidden');
    startButton.disabled = false;
    state.isAnalyzing = false;
}

function constructPrompt(iteration, bestRuleset, history) {
    const systemPrompt = `You are a world-class Baccarat analyst and logician. Your task is to find a set of rules that can predict the outcome of a sequence. You must return your findings as a JSON object with two keys: "explanation" (a human-readable summary of your rules in Vietnamese) and "rules" (a JSON array of machine-readable rule objects). The goal is to maximize the prediction accuracy.`;

    let userQuery = `Ph√¢n t√≠ch chu·ªói k·∫øt qu·∫£ Baccarat sau ƒë√¢y: [${history.slice(0, 200).join(', ')}]... (t·ªïng c·ªông ${history.length} v√°n).\n`;

    if (iteration === 1) {
        userQuery += "H√£y t√¨m v√† ƒë·ªÅ xu·∫•t m·ªôt b·ªô quy lu·∫≠t ban ƒë·∫ßu ƒë·ªÉ c√≥ th·ªÉ d·ª± ƒëo√°n k·∫øt qu·∫£ v·ªõi ƒë·ªô ch√≠nh x√°c cao nh·∫•t. C√°c quy lu·∫≠t c√≥ th·ªÉ d·ª±a tr√™n: ƒë·ªô d√†i c·∫ßu b·ªát, c·∫ßu 1-1, c√°c m·∫´u h√¨nh ƒë·∫∑c bi·ªát (v√≠ d·ª•: PBB, PPB), ho·∫∑c b·∫•t k·ª≥ quy lu·∫≠t n√†o kh√°c b·∫°n t√¨m th·∫•y. Cung c·∫•p c√¢u tr·∫£ l·ªùi d∆∞·ªõi d·∫°ng m·ªôt ƒë·ªëi t∆∞·ª£ng JSON.";
    } else {
        userQuery += `·ªû v√≤ng tr∆∞·ªõc, b·ªô quy lu·∫≠t sau ƒë√£ ƒë·∫°t ƒë·ªô ch√≠nh x√°c ${bestRuleset.accuracy.toFixed(2)}%:\n${bestRuleset.explanation}\n\nD·ª±a tr√™n d·ªØ li·ªáu g·ªëc, h√£y tinh ch·ªânh, k·∫øt h·ª£p ho·∫∑c lo·∫°i b·ªè c√°c quy lu·∫≠t n√†y ƒë·ªÉ t·∫°o ra m·ªôt b·ªô quy lu·∫≠t m·ªõi c√≥ ƒë·ªô ch√≠nh x√°c cao h∆°n. Cung c·∫•p b·ªô quy lu·∫≠t m·ªõi d∆∞·ªõi d·∫°ng m·ªôt ƒë·ªëi t∆∞·ª£ng JSON.`
    }

    return { systemPrompt, userQuery };
}

async function callGemini(systemPrompt, userQuery) {
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${state.apiKey}`;
    
    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
        generationConfig: {
            responseMimeType: "application/json",
            temperature: 0.2
        },
    };

    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    if (!response.ok) {
        const error = await response.json();
        throw new Error(`L·ªói API: ${error.error.message}`);
    }
    return response.json();
}

async function verifyRuleset(rules) {
    let correct = 0;
    let total = 0;
    const minHistory = 10;

    for (let i = minHistory; i < state.fullHistory.length; i++) {
        const historySlice = state.fullHistory.slice(0, i);
        const actualResult = state.fullHistory[i];

        // Find the first rule that applies
        let prediction = null;
        for (const rule of rules) {
            if (rule.type === 'streak') {
                const last = historySlice[historySlice.length - 1];
                let streak = 0;
                for (let j = historySlice.length - 1; j >= 0; j--) {
                    if (historySlice[j] === last) streak++;
                    else break;
                }
                if (last === rule.value && streak >= rule.length) {
                    prediction = rule.prediction;
                    break;
                }
            } else if (rule.type === 'sequence') {
                if (historySlice.length >= rule.length) {
                    const recentSequence = historySlice.slice(-rule.length).join('');
                    if (recentSequence === rule.value) {
                        prediction = rule.prediction;
                        break;
                    }
                }
            }
        }

        if (prediction) {
            total++;
            if (prediction === actualResult) {
                correct++;
            }
        }
    }
    
    const accuracy = total > 0 ? (correct / total) * 100 : 0;
    return { accuracy, correct, total };
}

function downloadResults() {
    if (!state.bestRuleset.rules || state.bestRuleset.rules.length === 0) {
        alert("Ch∆∞a c√≥ quy lu·∫≠t n√†o ƒë·ªÉ t·∫£i v·ªÅ.");
        return;
    }
    
    const content = `# C√îNG TR√åNH NGHI√äN C·ª®U BACCARAT\n\n## ƒê·ªô ch√≠nh x√°c cu·ªëi c√πng: ${state.bestRuleset.accuracy.toFixed(2)}%\n\n---\n\n## Gi·∫£i th√≠ch quy lu·∫≠t\n\n${state.bestRuleset.explanation}\n\n---\n\n## D·ªØ li·ªáu quy lu·∫≠t (JSON)\n\n\`\`\`json\n${JSON.stringify(state.bestRuleset.rules, null, 2)}\n\`\`\``;
    
    const blob = new Blob([content], { type: 'text/markdown' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'quy-luat-baccarat.md';
    link.click();
    URL.revokeObjectURL(link.href);
}

// --- Initial Setup ---
document.addEventListener('DOMContentLoaded', () => {
    checkCanStart();
});

</script>
</body>
</html>

